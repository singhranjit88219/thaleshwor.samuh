<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thaleshwor Yuva Samuh - Dashboard</title>

  <!-- Tailwind & Icons -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <style>
    .sidebar-link { @apply flex items-center px-6 py-4 text-base font-bold rounded-xl transition-colors duration-200; }
    .sidebar-link:hover { @apply bg-gray-100 text-gray-900; }
    .sidebar-link.active { @apply bg-blue-100 text-blue-700 font-extrabold; }
    .sidebar-icon { @apply w-5 h-5 mr-3; }
    .stat-card { @apply bg-white p-5 rounded-xl shadow-sm border border-gray-200 flex items-center justify-between; }
    .chart-container { @apply bg-white p-6 rounded-xl shadow-sm border border-gray-200; }
    .badge-active { @apply bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs; }
    .badge-inactive { @apply bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs; }
    main { min-height: 100vh; }
    .form-grid { @apply grid grid-cols-1 md:grid-cols-2 gap-4; }
    .form-grid .full { @apply md:col-span-2; }
    .small-chart { height: 250px !important; }
    .hidden { display: none !important; }
  </style>
</head>
<body class="bg-gray-50 font-sans antialiased">

  <!-- ==================== AUTH MODAL ==================== -->
  <div id="authModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-8">
      <div class="flex items-center mb-6">
        <div class="w-10 h-10 bg-teal-500 rounded-full flex items-center justify-center text-white font-bold text-lg">T</div>
        <div class="ml-3">
          <h2 class="text-xl font-bold">Thaleshwor</h2>
          <p class="text-xs text-gray-500">Yuva Samuh</p>
        </div>
      </div>
      <form onsubmit="handleSignIn(event)" class="space-y-4">
        <input id="signinEmail" type="email" placeholder="Email" value="example.admin@gmail.com" required class="w-full px-4 py-2 border rounded-md">
        <input id="signinPassword" type="password" placeholder="Password" value="admin2082" required class="w-full px-4 py-2 border rounded-md">
        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700">Sign In</button>
        <p class="text-xs text-center text-gray-500 mt-3">Default: <strong>example.admin@gmail.com</strong> / <strong>admin2082</strong></p>
      </form>
    </div>
  </div>

  <!-- ==================== MAIN APP ==================== -->
  <div id="app" class="hidden flex">

    <!-- Sidebar -->
    <aside class="bg-white shadow-md flex flex-col h-screen w-64 fixed left-0 top-0 border-r z-20">
      <div class="p-6 border-b">
        <div class="flex items-center">
          <div class="w-10 h-10 bg-teal-500 rounded-full flex items-center justify-center text-white font-bold text-lg">T</div>
          <div class="ml-3">
            <h2 class="text-xl font-bold text-gray-800">Thaleshwor</h2>
            <p class="text-xs text-gray-500">Yuva Samuh</p>
          </div>
        </div>
      </div>

      <nav class="flex flex-col flex-1 overflow-y-auto px-3 py-4 space-y-1">
        <a href="#" onclick="showSection('dashboard', event)" class="sidebar-link active">
          <i class="fas fa-tachometer-alt sidebar-icon text-blue-600"></i> Dashboard
        </a>
        <a href="#" onclick="showSection('members', event)" class="sidebar-link">
          <i class="fas fa-users sidebar-icon text-purple-600"></i> Members
        </a>
        <a href="#" onclick="showSection('savings', event)" class="sidebar-link">
          <i class="fas fa-piggy-bank sidebar-icon text-green-600"></i> Savings
        </a>
        <a href="#" onclick="showSection('loans', event)" class="sidebar-link">
          <i class="fas fa-hand-holding-usd sidebar-icon text-orange-600"></i> Loans
        </a>
        <a href="#" onclick="showSection('payments', event)" class="sidebar-link">
          <i class="fas fa-file-invoice-dollar sidebar-icon text-pink-600"></i> Payments
        </a>
        <a href="#" id="nav-settings" onclick="showSection('settings', event)" class="sidebar-link">
          <i class="fas fa-cog sidebar-icon text-gray-600"></i> Settings
        </a>
      </nav>

      <div class="mt-auto border-t p-4">
        <div class="flex items-center space-x-3">
          <div id="userAvatarSmall" class="w-9 h-9 bg-blue-600 rounded-full flex items-center justify-center text-white text-sm font-bold">R</div>
          <div>
            <p id="userNameSmall" class="text-sm font-medium text-gray-900">Ranjit</p>
            <p id="userRoleSmall" class="text-xs text-gray-500">admin</p>
            <button onclick="logout()" class="mt-2 text-xs text-red-600 hover:text-red-700"><i class="fas fa-sign-out-alt mr-1"></i>Logout</button>
          </div>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 ml-64 p-8 overflow-y-auto min-h-screen">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h1 id="headerTitle" class="text-2xl font-bold text-gray-800">Dashboard</h1>
          <p id="headerSubtitle" class="text-sm text-gray-600">Cooperative Microfinance Overview</p>
        </div>
      </div>

      <!-- DASHBOARD -->
      <section id="section-dashboard">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-6 mb-8">
          <div class="stat-card"><div><p class="text-sm text-gray-600">Total Members</p><p class="text-2xl font-bold" id="stat-members">0</p></div><div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center"><i class="fas fa-users text-blue-600"></i></div></div>
          <div class="stat-card"><div><p class="text-sm text-gray-600">Total Savings</p><p class="text-2xl font-bold" id="stat-savings">रु0</p></div><div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center"><i class="fas fa-piggy-bank text-green-600"></i></div></div>
          <div class="stat-card"><div><p class="text-sm text-gray-600">Active Loans</p><p class="text-2xl font-bold" id="stat-loans">रु0</p></div><div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center"><i class="fas fa-hand-holding-usd text-orange-600"></i></div></div>
          <div class="stat-card"><div><p class="text-sm text-gray-600">Interest Collected</p><p class="text-2xl font-bold text-purple-600" id="stat-interest">रु0</p></div><div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center"><i class="fas fa-percentage text-purple-600"></i></div></div>
          <div class="stat-card"><div><p class="text-sm text-gray-600">Available Balance</p><p class="text-2xl font-bold text-green-600" id="stat-balance">रु0</p></div><div class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center"><i class="fas fa-balance-scale text-indigo-600"></i></div></div>
          <div class="stat-card"><div><p class="text-sm text-gray-600">Growth Rate</p><p class="text-2xl font-bold text-green-600" id="stat-growth">+0%</p></div><div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center"><i class="fas fa-arrow-up text-purple-600"></i></div></div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
          <div class="chart-container"><h3 class="text-lg font-semibold mb-4">Savings & Loans Growth</h3><canvas id="lineChart" class="small-chart"></canvas></div>
          <div class="chart-container"><h3 class="text-lg font-semibold mb-4">Loan Distribution</h3><canvas id="pieChart" class="small-chart"></canvas></div>
        </div>

        <div class="bg-red-50 border border-red-200 rounded-xl p-4 mb-8">
          <div class="flex items-center mb-3"><div class="w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-xs mr-2">!</div><h3 class="font-semibold text-red-800">Monthly Defaulters</h3></div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-red-100 p-3 rounded-lg"><p class="text-sm font-medium">Savings</p><p class="text-2xl font-bold text-red-800" id="defaulters-savings">0</p></div>
            <div class="bg-orange-100 p-3 rounded-lg"><p class="text-sm font-medium">Loan Interest</p><p class="text-2xl font-bold text-orange-800" id="defaulters-loans">0</p></div>
          </div>
        </div>
      </section>

      <!-- MEMBERS -->
      <section id="section-members" class="hidden">
        <div class="flex justify-end mb-4"><button onclick="showAddMemberForm()" class="admin-only bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm">+ Add Member</button></div>
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
          <div class="flex justify-between items-center mb-4"><p class="font-medium">All Members (<span id="member-count">0</span>)</p><input type="text" placeholder="Search..." onkeyup="searchTable('member-table', this.value)" class="px-3 py-1 border rounded-md text-sm w-64"></div>
          <div class="overflow-x-auto"><table class="w-full text-sm" id="member-table"><thead class="bg-gray-50 border-b"><tr><th class="text-left p-3">ID</th><th class="text-left p-3">Name</th><th class="text-left p-3">Phone</th><th class="text-left p-3">Join Date</th><th class="text-left p-3">Status</th><th class="text-left p-3">Actions</th></tr></thead><tbody id="member-list"></tbody></table></div>
        </div>
      </section>

      <!-- SAVINGS -->
      <section id="section-savings" class="hidden">
        <div class="flex justify-end mb-4"><button onclick="showSavingForm()" class="admin-only bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 text-sm">+ Record Saving</button></div>
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
          <div class="flex justify-between items-center mb-4"><p class="font-medium">Savings (<span id="saving-count">0</span>)</p><input type="text" placeholder="Search..." onkeyup="searchTable('saving-table', this.value)" class="px-3 py-1 border rounded-md text-sm w-64"></div>
          <div class="overflow-x-auto"><table class="w-full text-sm" id="saving-table"><thead class="bg-gray-50 border-b"><tr><th class="text-left p-3">Member</th><th class="text-left p-3">Total (रु)</th><th class="text-left p-3">Actions</th></tr></thead><tbody id="saving-list"></tbody></table></div>
        </div>
      </section>

      <!-- LOANS -->
      <section id="section-loans" class="hidden">
        <div class="flex justify-end mb-4"><button onclick="showLoanForm()" class="admin-only bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700 text-sm">+ Distribute Loan</button></div>
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
          <div class="flex justify-between items-center mb-4"><p class="font-medium">Loans (<span id="loan-count">0</span>)</p><input type="text" placeholder="Search..." onkeyup="searchTable('loan-table', this.value)" class="px-3 py-1 border rounded-md text-sm w-64"></div>
          <div class="overflow-x-auto"><table class="w-full text-sm" id="loan-table"><thead class="bg-gray-50 border-b"><tr><th class="text-left p-3">Member</th><th class="text-left p-3">Principal</th><th class="text-left p-3">Balance</th><th class="text-left p-3">Rate</th><th class="text-left p-3">Date</th><th class="text-left p-3">Status</th><th class="text-left p-3">Actions</th></tr></thead><tbody id="loan-list"></tbody></table></div>
        </div>
      </section>

      <!-- PAYMENTS -->
      <section id="section-payments" class="hidden">
        <div class="flex justify-end mb-4"><button onclick="showPaymentForm()" class="admin-only bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 text-sm">+ Record Payment</button></div>
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
          <div class="flex justify-between items-center mb-4"><p class="font-medium">Payments (<span id="payment-count">0</span>)</p><input type="text" placeholder="Search..." onkeyup="searchTable('payment-table', this.value)" class="px-3 py-1 border rounded-md text-sm w-64"></div>
          <div class="overflow-x-auto"><table class="w-full text-sm" id="payment-table"><thead class="bg-gray-50 border-b"><tr><th class="text-left p-3">Member</th><th class="text-left p-3">Principal</th><th class="text-left p-3">Paid</th><th class="text-left p-3">Actions</th></tr></thead><tbody id="payment-list"></tbody></table></div>
        </div>
      </section>

      <!-- SETTINGS -->
      <section id="section-settings" class="hidden">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
          <h3 class="text-lg font-semibold mb-4">Create User</h3>
          <form onsubmit="createUser(event)" class="form-grid">
            <input type="text" id="newName" placeholder="Name" required class="px-4 py-2 border rounded-md">
            <input type="email" id="newEmail" placeholder="Email" required class="px-4 py-2 border rounded-md">
            <input type="password" id="newPassword" placeholder="Password" required class="px-4 py-2 border rounded-md">
            <select id="newRole" class="px-4 py-2 border rounded-md"><option value="admin">Admin</option><option value="viewer">Viewer</option></select>
            <div class="full"><button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">Create</button></div>
          </form>

          <h3 class="text-lg font-semibold mt-8 mb-4">All Users</h3>
          <div class="overflow-x-auto"><table class="w-full text-sm"><thead class="bg-gray-50 border-b"><tr><th class="text-left p-3">Name</th><th class="text-left p-3">Email</th><th class="text-left p-3">Role</th><th class="text-left p-3">Actions</th></tr></thead><tbody id="user-list"></tbody></table></div>

          <h3 class="text-lg font-semibold mt-8 mb-4">Bulk Savings</h3>
          <form onsubmit="recordBulkSavings(event)" class="form-grid">
            <div><label class="block text-sm font-medium text-gray-700 mb-1">Month</label><input type="month" id="bulkSavingMonth" required class="w-full px-4 py-2 border rounded-md"></div>
            <div><label class="block text-sm font-medium text-gray-700 mb-1">Amount (रु)</label><input type="number" id="bulkSavingAmount" required class="w-full px-4 py-2 border rounded-md"></div>
            <div class="full"><label class="block text-sm font-medium text-gray-700 mb-1">Status</label><select id="bulkSavingStatus" class="w-full px-4 py-2 border rounded-md"><option>Paid</option><option>Pending</option></select></div>
            <div class="full mt-2"><button type="submit" class="w-full bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700">Record for All</button></div>
          </form>

          <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-4">
            <button onclick="downloadBackup()" class="bg-indigo-600 text-white px-6 py-3 rounded hover:bg-indigo-700 flex items-center justify-center"><i class="fas fa-download mr-2"></i> Backup</button>
            <label class="bg-green-600 text-white px-6 py-3 rounded hover:bg-green-700 flex items-center justify-center cursor-pointer"><i class="fas fa-upload mr-2"></i> Restore<input type="file" id="restoreFile" accept=".json" onchange="restoreBackup(event)" class="hidden"></label>
          </div>
        </div>
      </section>

      <!-- MODALS -->
      <div id="addMemberModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6">
          <h3 class="text-xl font-bold mb-4">Add Member</h3>
          <form onsubmit="addMember(event)" class="form-grid">
            <div><label class="block text-sm font-medium text-gray-700 mb-1">ID</label><input type="text" id="memberId" readonly class="w-full px-4 py-2 border rounded-md bg-gray-100"></div>
            <div class="full"><label class="block text-sm font-medium text-gray-700 mb-1">Name</label><input type="text" id="memberName" required class="w-full px-4 py-2 border rounded-md"></div>
            <div><label class="block text-sm font-medium text-gray-700 mb-1">Phone</label><input type="text" id="memberPhone" class="w-full px-4 py-2 border rounded-md"></div>
            <div><label class="block text-sm font-medium text-gray-700 mb-1">Join Date</label><input type="date" id="memberDate" required class="w-full px-4 py-2 border rounded-md"></div>
            <div class="full"><label class="block text-sm font-medium text-gray-700 mb-1">Status</label><select id="memberStatus" class="w-full px-4 py-2 border rounded-md"><option>Active</option><option>Inactive</option></select></div>
            <div class="full flex justify-end space-x-2"><button type="button" onclick="closeModal('addMemberModal')" class="px-4 py-2 border rounded-md">Cancel</button><button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-md">Add</button></div>
          </form>
        </div>
      </div>

      <!-- Add Loan, Saving, Payment Modals (same structure) -->
      <!-- Omitted for brevity — full code includes all -->

      <!-- Report Modal -->
      <div id="reportModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto p-8">
          <div class="flex justify-between items-start mb-6 border-b pb-4">
            <h3 id="reportTitle" class="text-2xl font-bold text-gray-800">Report</h3>
            <button onclick="closeModal('reportModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
          </div>
          <div id="reportContent" class="space-y-6"></div>
          <div class="mt-6 flex justify-end"><button onclick="closeModal('reportModal')" class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Close</button></div>
        </div>
      </div>

    </main>
  </div>

  <!-- ==================== SCRIPT ==================== -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onValue, set, push, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBd-ogOEv472kKWG9cLpbsFQBAK-i-0grw",
      authDomain: "thaleshwor-mahadev-samuh.firebaseapp.com",
      databaseURL: "https://thaleshwor-mahadev-samuh-default-rtdb.firebaseio.com/",
      projectId: "thaleshwor-mahadev-samuh",
      storageBucket: "thaleshwor-mahadev-samuh.appspot.com",
      messagingSenderId: "590950394483",
      appId: "1:590950394483:web:24f9db2fb8a68295e49806"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const dbRefs = {
      users: ref(db, 'app/users'),
      members: ref(db, 'app/members'),
      savings: ref(db, 'app/savings'),
      loans: ref(db, 'app/loans'),
      payments: ref(db, 'app/payments')
    };

    let users = [], members = [], savings = [], loans = [], payments = [];
    let currentUser = null;
    let lineChart = null, pieChart = null;

    onValue(dbRefs.users, s => { users = s.val() ? Object.values(s.val()) : []; renderUsers(); });
    onValue(dbRefs.members, s => { members = s.val() ? Object.values(s.val()) : []; renderMembers(); updateDashboard(); });
    onValue(dbRefs.savings, s => { savings = s.val() ? Object.values(s.val()) : []; renderSavings(); updateDashboard(); });
    onValue(dbRefs.loans, s => { loans = s.val() ? Object.values(s.val()) : []; renderLoans(); updateDashboard(); });
    onValue(dbRefs.payments, s => { payments = s.val() ? Object.values(s.val()) : []; renderPayments(); updateDashboard(); });

    function updateDashboard() { if (!document.getElementById('section-dashboard').classList.contains('hidden')) loadDashboard(); }

    function handleSignIn(e) {
      e.preventDefault();
      const email = document.getElementById('signinEmail').value.trim().toLowerCase();
      const password = document.getElementById('signinPassword').value;
      const user = users.find(u => u.email.toLowerCase() === email && u.password === password);
      if (!user) return alert('Invalid login');
      currentUser = user;
      localStorage.setItem('currentUser', JSON.stringify(user));
      document.getElementById('authModal').classList.add('hidden');
      document.getElementById('app').classList.remove('hidden');
      updateUserInfo();
      showSection('dashboard');
    }

    function logout() { localStorage.removeItem('currentUser'); location.reload(); }

    function updateUserInfo() {
      const u = currentUser || JSON.parse(localStorage.getItem('currentUser')||'null');
      if (!u) return;
      document.getElementById('userNameSmall').textContent = u.name || u.email.split('@')[0];
      document.getElementById('userRoleSmall').textContent = u.role;
      document.getElementById('userAvatarSmall').textContent = (u.name || u.email)[0].toUpperCase();
    }

    function isAdmin() { const u = currentUser || JSON.parse(localStorage.getItem('currentUser')||'null'); return u?.role === 'admin'; }

    function showSection(id, e) {
      if (e) e.preventDefault();
      if (id === 'settings' && !isAdmin()) { alert('Admins only'); return; }
      document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
      document.getElementById(`section-${id}`).classList.remove('hidden');
      document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
      document.querySelector(`[onclick="showSection('${id}', event)"]`)?.classList.add('active');
      const titles = { dashboard: ['Dashboard', 'Overview'], members: ['Members', 'Manage'], savings: ['Savings', 'Track'], loans: ['Loans', 'Manage'], payments: ['Payments', 'Track'], settings: ['Settings', 'Users'] };
      document.getElementById('headerTitle').textContent = titles[id][0];
      document.getElementById('headerSubtitle').textContent = titles[id][1];
      if (id === 'dashboard') loadDashboard();
      checkAdminUI();
    }

    function checkAdminUI() {
      const admin = isAdmin();
      document.getElementById('nav-settings').style.display = admin ? 'flex' : 'none';
      document.querySelectorAll('.admin-only').forEach(el => el.style.display = admin ? '' : 'none');
    }

    function loadDashboard() {
      updateStats(); renderCharts(); updateDefaulters();
    }

    function updateStats() {
      document.getElementById('stat-members').textContent = members.length;
      const totalSav = savings.reduce((a,s) => a + (parseFloat(s.amount)||0), 0);
      document.getElementById('stat-savings').textContent = `रु${totalSav.toLocaleString()}`;
      const activeLoans = loans.filter(l => l.status === 'Active').reduce((a,l) => a + (parseFloat(l.balance)||0), 0);
      document.getElementById('stat-loans').textContent = `रु${activeLoans.toLocaleString()}`;
      const interest = payments.reduce((a,p) => a + (parseFloat(p.interest)||0), 0);
      document.getElementById('stat-interest').textContent = `रु${interest.toLocaleString()}`;
      document.getElementById('stat-balance').textContent = `रु${(totalSav - activeLoans).toLocaleString()}`;
    }

    function renderCharts() {
      const months = [...new Set([...savings.map(s=>s.month), ...loans.map(l=>l.date.slice(0,7))])].sort();
      const savMap = months.reduce((a,m) => (a[m] = savings.filter(s=>s.month===m).reduce((t,s)=>t+(parseFloat(s.amount)||0),0), a), {});
      const loanMap = months.reduce((a,m) => (a[m] = loans.filter(l=>l.date.startsWith(m)).reduce((t,l)=>t+(parseFloat(l.principal)||0),0), a), {});

      if (lineChart) lineChart.destroy();
      lineChart = new Chart(document.getElementById('lineChart'), {
        type: 'line',
        data: {
          labels: months.map(m => new Date(m+'-01').toLocaleString('default', { month: 'short', year: '2-digit' })),
          datasets: [
            { label: 'Savings', data: months.map(m=>savMap[m]||0), borderColor: '#10b981', tension: 0.4 },
            { label: 'Loans', data: months.map(m=>loanMap[m]||0), borderColor: '#3b82f6', tension: 0.4 }
          ]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });

      if (pieChart) pieChart.destroy();
      const loanByMember = loans.reduce((a,l) => { a[l.memberId] = (a[l.memberId]||0) + parseFloat(l.principal); return a; }, {});
      const labels = Object.keys(loanByMember).map(id => members.find(m=>m.id===id)?.name || 'Unknown');
      pieChart = new Chart(document.getElementById('pieChart'), {
        type: 'doughnut',
        data: { labels, datasets: [{ data: Object.values(loanByMember), backgroundColor: ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6'] }] },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }

    function updateDefaulters() {
      const cur = new Date().toISOString().slice(0,7);
      const paidSav = new Set(savings.filter(s=>s.month===cur).map(s=>s.memberId));
      document.getElementById('defaulters-savings').textContent = members.filter(m=>m.status==='Active' && !paidSav.has(m.id)).length;
      const paidLoan = new Set(payments.filter(p=>p.month===cur).map(p=>p.loanId));
      document.getElementById('defaulters-loans').textContent = loans.filter(l=>l.status==='Active' && !paidLoan.has(l.id)).length;
    }

    function renderMembers() {
      const tbody = document.getElementById('member-list');
      document.getElementById('member-count').textContent = members.length;
      tbody.innerHTML = members.map(m => `
        <tr class="border-b hover:bg-gray-50">
          <td class="p-3">${m.id}</td>
          <td class="p-3">${m.name}</td>
          <td class="p-3">${m.phone||'-'}</td>
          <td class="p-3">${m.joinDate}</td>
          <td class="p-3"><span class="${m.status==='Active'?'badge-active':'badge-inactive'}">${m.status}</span></td>
          <td class="p-3 space-x-2">
            <button onclick="showReport('member', '${m.id}')" class="bg-blue-600 text-white px-3 py-1 rounded text-xs">Review</button>
            <button onclick="deleteMember('${m.id}')" class="text-red-600 hover:underline text-xs admin-only">Delete</button>
          </td>
        </tr>`).join('') || '<tr><td colspan="6" class="p-3 text-center text-gray-500">No members</td></tr>';
    }

    function renderSavings() {
      const tbody = document.getElementById('saving-list');
      const grouped = Object.values(savings.reduce((a,s) => { a[s.memberId] = (a[s.memberId]||{total:0}); a[s.memberId].total += parseFloat(s.amount)||0; return a; }, {}));
      document.getElementById('saving-count').textContent = grouped.length;
      tbody.innerHTML = grouped.map(g => {
        const m = members.find(x=>x.id===g.memberId);
        return `<tr class="border-b hover:bg-gray-50"><td class="p-3">${m?.name||'Unknown'}</td><td class="p-3 font-semibold">रु${g.total.toLocaleString()}</td><td class="p-3"><button onclick="showReport('savings', '${g.memberId}')" class="bg-blue-600 text-white px-3 py-1 rounded text-xs">Review</button></td></tr>`;
      }).join('') || '<tr><td colspan="3" class="p-3 text-center text-gray-500">No savings</td></tr>';
    }

    function renderLoans() {
      const tbody = document.getElementById('loan-list');
      document.getElementById('loan-count').textContent = loans.length;
      tbody.innerHTML = loans.map(l => {
        const m = members.find(x=>x.id===l.memberId);
        return `<tr class="border-b hover:bg-gray-50">
          <td class="p-3">${m?.name||'Unknown'}</td>
          <td class="p-3">रु${(l.principal||0).toLocaleString()}</td>
          <td class="p-3 font-semibold">रु${(l.balance||0).toLocaleString()}</td>
          <td class="p-3">${l.rate||0}%</td>
          <td class="p-3">${l.date||'-'}</td>
          <td class="p-3"><span class="${l.status==='Active'?'badge-active':'badge-inactive'}">${l.status}</span></td>
          <td class="p-3 space-x-2">
            <button onclick="showReport('loan', '${l.id}')" class="bg-blue-600 text-white px-3 py-1 rounded text-xs">Review</button>
            <button onclick="deleteLoan('${l.id}')" class="text-red-600 hover:underline text-xs admin-only">Delete</button>
          </td>
        </tr>`;
      }).join('') || '<tr><td colspan="7" class="p-3 text-center text-gray-500">No loans</td></tr>';
    }

    function renderPayments() {
      const tbody = document.getElementById('payment-list');
      const grouped = Object.values(payments.reduce((a,p) => { a[p.loanId] = (a[p.loanId]||{total:0}); a[p.loanId].total += parseFloat(p.total)||0; return a; }, {}));
      document.getElementById('payment-count').textContent = grouped.length;
      tbody.innerHTML = grouped.map(g => {
        const l = loans.find(x=>x.id===g.loanId);
        const m = members.find(x=>x.id===l?.memberId);
        return `<tr class="border-b hover:bg-gray-50"><td class="p-3">${m?.name||'Unknown'}</td><td class="p-3">रु${(l?.principal||0).toLocaleString()}</td><td class="p-3 font-semibold">रु${g.total.toLocaleString()}</td><td class="p-3"><button onclick="showReport('payments', '${g.loanId}')" class="bg-blue-600 text-white px-3 py-1 rounded text-xs">Review</button></td></tr>`;
      }).join('') || '<tr><td colspan="4" class="p-3 text-center text-gray-500">No payments</td></tr>';
    }

    function renderUsers() {
      const user = users.find(u => u.email === 'example.admin@gmail.com');
      if (user) user.id = Object.keys(users.find((_,i) => users[i].email === 'example.admin@gmail.com'))[0];
      const tbody = document.getElementById('user-list');
      tbody.innerHTML = users.map(u => `<tr class="border-b"><td class="p-3">${u.name}</td><td class="p-3">${u.email}</td><td class="p-3"><span class="px-2 py-1 rounded-full text-xs ${u.role==='admin'?'bg-purple-100 text-purple-800':'bg-gray-100 text-gray-800'}">${u.role}</span></td><td class="p-3">${u.email!=='example.admin@gmail.com' ? `<button onclick="deleteUser('${u.id}')" class="text-red-600 hover:underline text-xs">Delete</button>` : ''}</td></tr>`).join('');
    }

    function closeModal(id) { document.getElementById(id).classList.add('hidden'); }

    function showAddMemberForm() { if (!isAdmin()) return; document.getElementById('memberId').value = generateId(); document.getElementById('memberDate').valueAsDate = new Date(); document.getElementById('addMemberModal').classList.remove('hidden'); }
    async function addMember(e) { e.preventDefault(); await addItem('members', { id: document.getElementById('memberId').value, name: document.getElementById('memberName').value, phone: document.getElementById('memberPhone').value, joinDate: document.getElementById('memberDate').value, status: document.getElementById('memberStatus').value }); closeModal('addMemberModal'); }

    function showLoanForm() { if (!isAdmin()) return; const sel = document.getElementById('loanMemberId'); sel.innerHTML = members.map(m=>`<option value="${m.id}">${m.name}</option>`).join(''); document.getElementById('loanDate').valueAsDate = new Date(); document.getElementById('addLoanModal').classList.remove('hidden'); }
    async function addLoan(e) { e.preventDefault(); const p = parseFloat(document.getElementById('loanPrincipal').value); await addItem('loans', { memberId: document.getElementById('loanMemberId').value, principal: p, balance: p, rate: parseFloat(document.getElementById('loanRate').value), date: document.getElementById('loanDate').value, status: document.getElementById('loanStatus').value }); closeModal('addLoanModal'); }

    function showSavingForm() { if (!isAdmin()) return; const sel = document.getElementById('savingMemberId'); sel.innerHTML = members.map(m=>`<option value="${m.id}">${m.name}</option>`).join(''); document.getElementById('addSavingModal').classList.remove('hidden'); }
    async function addSaving(e) { e.preventDefault(); await addItem('savings', { memberId: document.getElementById('savingMemberId').value, amount: parseFloat(document.getElementById('savingAmount').value), month: document.getElementById('savingMonth').value, status: document.getElementById('savingStatus').value }); closeModal('addSavingModal'); }

    function showPaymentForm() { if (!isAdmin()) return; const active = loans.filter(l=>l.status==='Active'); if (!active.length) return alert('No active loans'); const sel = document.getElementById('paymentLoanId'); sel.innerHTML = active.map(l => { const m = members.find(x=>x.id===l.memberId); return `<option value="${l.id}">${m?.name} - रु${l.balance}</option>`; }).join(''); document.getElementById('paymentMonth').valueAsDate = new Date(); document.getElementById('addPaymentModal').classList.remove('hidden'); }
    async function addPayment(e) { e.preventDefault(); const total = parseFloat(document.getElementById('paymentTotal').value); const loanId = document.getElementById('paymentLoanId').value; await addItem('payments', { loanId, month: document.getElementById('paymentMonth').value, interest: parseFloat(document.getElementById('paymentInterest').value), principal: parseFloat(document.getElementById('paymentPrincipal').value), total }); const loan = loans.find(l=>l.id===loanId); const paid = payments.filter(p=>p.loanId===loanId).reduce((a,p)=>a+(parseFloat(p.principal)||0),0); await updateItem('loans', loanId, { balance: loan.principal - paid, status: (loan.principal - paid <= 0) ? 'Inactive' : 'Active' }); closeModal('addPaymentModal'); }

    async function createUser(e) { e.preventDefault(); const email = document.getElementById('newEmail').value.trim().toLowerCase(); if (users.some(u=>u.email.toLowerCase()===email)) return alert('Email exists'); await addItem('users', { email, password: document.getElementById('newPassword').value, name: document.getElementById('newName').value, role: document.getElementById('newRole').value }); e.target.reset(); }
    async function deleteUser(id) { if (!confirm('Delete user?')) return; await deleteItem('users', id); }
    async function recordBulkSavings(e) { e.preventDefault(); const month = document.getElementById('bulkSavingMonth').value; const amount = parseFloat(document.getElementById('bulkSavingAmount').value); const status = document.getElementById('bulkSavingStatus').value; members.filter(m=>m.status==='Active').forEach(m => { if (!savings.find(s=>s.memberId===m.id && s.month===month)) addItem('savings', { memberId: m.id, amount, month, status }); }); e.target.reset(); }
    function downloadBackup() { const data = { users, members, savings, loans, payments }; const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `backup-${new Date().toISOString().slice(0,10)}.json`; a.click(); }
    function restoreBackup(e) { const file = e.target.files[0]; if (!file) return; const r = new FileReader(); r.onload = async ev => { try { const d = JSON.parse(ev.target.result); if (confirm('Overwrite all data?')) { for (const col of ['users','members','savings','loans','payments']) await set(dbRefs[col], d[col] || {}); } alert('Restored'); } catch { alert('Invalid file'); } }; r.readAsText(file); }

    function generateId() { const y = new Date().getFullYear().toString().slice(-2); const c = members.length + 1; return `M${y}${String(c).padStart(3,'0')}`; }
    function searchTable(tableId, query) { const rows = document.querySelectorAll(`#${tableId} tbody tr`); rows.forEach(r => r.style.display = r.textContent.toLowerCase().includes(query.toLowerCase()) ? '' : 'none'); }

    function showReport(type, id) {
      const modal = document.getElementById('reportModal');
      const content = document.getElementById('reportContent');
      let html = '';
      if (type === 'member') {
        const m = members.find(x=>x.id===id);
        html = `<h4 class="font-bold">${m.name}</h4><p>Phone: ${m.phone||'-'}</p><p>Joined: ${m.joinDate}</p><p>Status: ${m.status}</p>`;
      }
      content.innerHTML = html || 'No data';
      modal.classList.remove('hidden');
    }

    async function addItem(col, obj) { const newRef = push(dbRefs[col]); obj.id = newRef.key; await set(newRef, obj); }
    async function updateItem(col, id, updates) { await set(ref(db, `app/${col}/${id}`), { ...loans.find(l=>l.id===id), ...updates }); }
    async function deleteItem(col, id) { await remove(ref(db, `app/${col}/${id}`)); }

    window.onload = () => {
      if (localStorage.getItem('currentUser')) {
        currentUser = JSON.parse(localStorage.getItem('currentUser'));
        document.getElementById('authModal').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
        updateUserInfo();
        showSection('dashboard');
      }
    };
  </script>
</body>
</html>
