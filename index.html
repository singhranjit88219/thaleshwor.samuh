<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>श्री थलेश्वर महादेव युवा समूह  - Dashboard</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <style>
    .sidebar-link { @apply flex items-center px-6 py-4 text-base font-bold rounded-xl transition-colors duration-200; }
    .sidebar-link:hover { @apply bg-gray-100 text-gray-900; }
    .sidebar-link.active { @apply bg-blue-100 text-blue-700 font-extrabold; }
    .sidebar-icon { @apply w-5 h-5 mr-3; }
    .stat-card { @apply bg-white p-5 rounded-xl shadow-sm border border-gray-200 flex items-center justify-between; }
    .chart-container { @apply bg-white p-6 rounded-xl shadow-sm border border-gray-200; }
    .badge-active { @apply bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs; }
    .badge-inactive { @apply bg-red-100 text-red-800 px-2 py-1 rounded-full text-xs; }
    main { min-height: 100vh; }
    .form-grid { @apply grid grid-cols-1 md:grid-cols-2 gap-4; }
    .form-grid .full { @apply md:col-span-2; }
    .small-chart { height: 250px !important; }
  </style>
</head>
<body class="bg-gray-50 font-sans antialiased">

  <div id="authModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-8">
      <div class="flex items-center mb-6">
        <div class="w-10 h-10 bg-teal-500 rounded-full flex items-center justify-center text-white font-bold text-lg">T</div>
        <div class="ml-3">
          <h2 class="text-xl font-bold">श्री थलेश्वर</h2>
          <p class="text-xs text-gray-500">महादेव युवा समूह</p>
        </div>
      </div>
      <form onsubmit="handleSignIn(event)" class="space-y-4">
        <input id="signinEmail" type="email" placeholder="Email" value="useradmin@example.com" required class="w-full px-4 py-2 border rounded-md">
        <input id="signinPassword" type="password" placeholder="Password" value="useradmin" required class="w-full px-4 py-2 border rounded-md">
        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700">Sign In</button>
        <p class="text-xs text-center text-gray-500 mt-3">Default: <strong>example@gmail.com</strong> / <strong>example123</strong></p>
      </form>
    </div>
  </div>

  <div id="app" class="hidden flex">

    <aside class="bg-white shadow-md flex flex-col h-screen w-64 fixed left-0 top-0 border-r z-20">
      <div class="p-6 border-b">
        <div class="flex items-center">
          <div class="w-10 h-10 bg-teal-500 rounded-full flex items-center justify-center text-white font-bold text-lg">T</div>
          <div class="ml-3">
            <h2 class="text-xl font-bold text-gray-800">श्री थलेश्वर</h2>
            <p class="text-xs text-gray-500">महादेव युवा समूह </p>
          </div>
        </div>
      </div>

      <nav class="flex flex-col flex-1 overflow-y-auto px-3 py-4 space-y-1">
        <a href="#" id="nav-dashboard" onclick="showSection('dashboard')" class="sidebar-link active">
          <i class="fas fa-tachometer-alt sidebar-icon text-blue-600"></i> Dashboard
        </a>
        <a href="#" id="nav-members" onclick="showSection('members')" class="sidebar-link">
          <i class="fas fa-users sidebar-icon text-purple-600"></i> Members
        </a>
        <a href="#" id="nav-savings" onclick="showSection('savings')" class="sidebar-link">
          <i class="fas fa-piggy-bank sidebar-icon text-green-600"></i> Savings
        </a>
        <a href="#" id="nav-loans" onclick="showSection('loans')" class="sidebar-link">
          <i class="fas fa-hand-holding-usd sidebar-icon text-orange-600"></i> Loans
        </a>
        <a href="#" id="nav-payments" onclick="showSection('payments')" class="sidebar-link">
          <i class="fas fa-file-invoice-dollar sidebar-icon text-pink-600"></i> Payments
        </a>
        <a href="#" id="nav-settings" onclick="showSection('settings')" class="sidebar-link">
          <i class="fas fa-cog sidebar-icon text-gray-600"></i> Settings
        </a>
      </nav>

      <div class="mt-auto border-t p-4">
        <div class="flex items-center space-x-3">
          <div id="userAvatarSmall" class="w-9 h-9 bg-blue-600 rounded-full flex items-center justify-center text-white text-sm font-bold">R</div>
          <div>
            <p id="userNameSmall" class="text-sm font-medium text-gray-900">Ranjit Singh</p>
            <p id="userRoleSmall" class="text-xs text-gray-500">admin</p>
            <button onclick="logout()" class="mt-2 text-xs text-red-600 hover:text-red-700"><i class="fas fa-sign-out-alt mr-1"></i>Logout</button>
          </div>
        </div>
      </div>
    </aside>

    <main class="flex-1 ml-64 p-8 overflow-y-auto min-h-screen">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h1 id="headerTitle" class="text-2xl font-bold text-gray-800">Dashboard</h1>
          <p id="headerSubtitle" class="text-sm text-gray-600">Cooperative Microfinance Overview</p>
        </div>
      </div>

      <section id="section-dashboard">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-6 mb-8">
          <div class="stat-card">
            <div>
              <p class="text-sm text-gray-600">Total Members</p>
              <p class="text-2xl font-bold" id="stat-members">0</p>
            </div>
            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
              <i class="fas fa-users text-blue-600"></i>
            </div>
          </div>
          <div class="stat-card">
            <div>
              <p class="text-sm text-gray-600">Total Savings</p>
              <p class="text-2xl font-bold" id="stat-savings">रु0</p>
            </div>
            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
              <i class="fas fa-piggy-bank text-green-600"></i>
            </div>
          </div>
          <div class="stat-card">
            <div>
              <p class="text-sm text-gray-600">Active Loans</p>
              <p class="text-2xl font-bold" id="stat-loans">रु0</p>
            </div>
            <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center">
              <i class="fas fa-hand-holding-usd text-orange-600"></i>
            </div>
          </div>
          <div class="stat-card">
            <div>
              <p class="text-sm text-gray-600">Interest Collected</p>
              <p class="text-2xl font-bold text-purple-600" id="stat-interest">रु0</p>
            </div>
            <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
              <i class="fas fa-percentage text-purple-600"></i>
            </div>
          </div>
          <div class="stat-card">
            <div>
              <p class="text-sm text-gray-600">Available Balance</p>
              <p class="text-2xl font-bold text-green-600" id="stat-balance">रु0</p>
            </div>
            <div class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center">
              <i class="fas fa-balance-scale text-indigo-600"></i>
            </div>
          </div>
          <div class="stat-card">
            <div>
              <p class="text-sm text-gray-600">Growth Rate</p>
              <p class="text-2xl font-bold text-green-600" id="stat-growth">+0%</p>
            </div>
            <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
              <i class="fas fa-arrow-up text-purple-600"></i>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
          <div class="chart-container">
            <h3 class="text-lg font-semibold mb-4">Savings & Loans Growth</h3>
            <canvas id="lineChart" class="small-chart"></canvas>
          </div>
          <div class="chart-container">
            <h3 class="text-lg font-semibold mb-4">Loan Distribution by Member</h3>
            <canvas id="pieChart" class="small-chart"></canvas>
          </div>
        </div>

        <div class="bg-red-50 border border-red-200 rounded-xl p-4 mb-8">
          <div class="flex items-center mb-3">
            <div class="w-6 h-6 bg-red-500 text-white rounded-full flex items-center justify-center text-xs mr-2">!</div>
            <h3 class="font-semibold text-red-800">Monthly Defaulters</h3>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-red-100 p-3 rounded-lg">
              <p class="text-sm font-medium">Savings Defaulters</p>
              <p class="text-2xl font-bold text-red-800" id="defaulters-savings">0</p>
            </div>
            <div class="bg-orange-100 p-3 rounded-lg">
              <p class="text-sm font-medium">Loan Interest Defaulters</p>
              <p class="text-2xl font-bold text-orange-800" id="defaulters-loans">0</p>
            </div>
          </div>
        </div>
      </section>

      <section id="section-members" class="hidden">
        <div class="flex justify-end mb-4">
          <button onclick="showAddMemberForm()" class="admin-only bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm">+ Add Member</button>
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
          <div class="flex justify-between items-center mb-4">
            <p class="font-medium">All Members (<span id="member-count">0</span>)</p>
            <input type="text" placeholder="Search..." onkeyup="searchTable('member-table', this.value)" class="px-3 py-1 border rounded-md text-sm w-64">
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm" id="member-table">
              <thead class="bg-gray-50 border-b">
                <tr>
                  <th class="text-left p-3">ID</th>
                  <th class="text-left p-3">Name</th>
                  <th class="text-left p-3">Phone</th>
                  <th class="text-left p-3">Join Date</th>
                  <th class="text-left p-3">Status</th>
                  <th class="text-left p-3">Actions</th>
                </tr>
              </thead>
              <tbody id="member-list"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="section-savings" class="hidden">
        <div class="flex justify-end mb-4">
          <button onclick="showSavingForm()" class="admin-only bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 text-sm">+ Record Saving</button>
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
          <div class="flex justify-between items-center mb-4">
            <p class="font-medium">Savings by Member (<span id="saving-count">0</span>)</p>
            <input type="text" placeholder="Search..." onkeyup="searchTable('saving-table', this.value)" class="px-3 py-1 border rounded-md text-sm w-64">
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm" id="saving-table">
              <thead class="bg-gray-50 border-b">
                <tr>
                  <th class="text-left p-3">Member</th>
                  <th class="text-left p-3">Total (रु)</th>
                  <th class="text-left p-3">Actions</th>
                </tr>
              </thead>
              <tbody id="saving-list"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="section-loans" class="hidden">
        <div class="flex justify-end mb-4">
          <button onclick="showLoanForm()" class="admin-only bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700 text-sm">+ Distribute Loan</button>
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
          <div class="flex justify-between items-center mb-4">
            <p class="font-medium">All Loans (<span id="loan-count">0</span>)</p>
            <input type="text" placeholder="Search..." onkeyup="searchTable('loan-table', this.value)" class="px-3 py-1 border rounded-md text-sm w-64">
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm" id="loan-table">
              <thead class="bg-gray-50 border-b">
                <tr>
                  <th class="text-left p-3">Member</th>
                  <th class="text-left p-3">Principal (रु)</th>
                  <th class="text-left p-3">Balance (रु)</th>
                  <th class="text-left p-3">Rate (%)</th>
                  <th class="text-left p-3">Date</th>
                  <th class="text-left p-3">Status</th>
                  <th class="text-left p-3">Actions</th>
                </tr>
              </thead>
              <tbody id="loan-list"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="section-payments" class="hidden">
        <div class="flex justify-end mb-4">
          <button onclick="showPaymentForm()" class="admin-only bg-purple-600 text-white px-4 py-2 rounded hover:bg-purple-700 text-sm">+ Record Payment</button>
        </div>
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
          <div class="flex justify-between items-center mb-4">
            <p class="font-medium">Payments by Loan (<span id="payment-count">0</span>)</p>
            <input type="text" placeholder="Search..." onkeyup="searchTable('payment-table', this.value)" class="px-3 py-1 border rounded-md text-sm w-64">
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-sm" id="payment-table">
              <thead class="bg-gray-50 border-b">
                <tr>
                  <th class="text-left p-3">Member</th>
                  <th class="text-left p-3">Principal (रु)</th>
                  <th class="text-left p-3">Total Paid (रु)</th>
                  <th class="text-left p-3">Actions</th>
                </tr>
              </thead>
              <tbody id="payment-list"></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="section-settings" class="hidden">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
          <h3 class="text-lg font-semibold mb-4">Create User</h3>
          <form onsubmit="createUser(event)" class="form-grid">
            <input type="text" id="newName" placeholder="Full Name" required class="px-4 py-2 border rounded-md">
            <input type="email" id="newEmail" placeholder="Email" required class="px-4 py-2 border rounded-md">
            <input type="password" id="newPassword" placeholder="Password" required class="px-4 py-2 border rounded-md">
            <select id="newRole" class="px-4 py-2 border rounded-md">
              <option value="admin">Admin</option>
              <option value="viewer">Viewer</option>
            </select>
            <div class="full">
              <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 w-full md:w-auto">Create User</button>
            </div>
          </form>

          <h3 class="text-lg font-semibold mt-8 mb-4">All Users</h3>
          <div class="overflow-x-auto">
            <table class="w-full text-sm">
              <thead class="bg-gray-50 border-b">
                <tr>
                  <th class="text-left p-3">Name</th>
                  <th class="text-left p-3">Email</th>
                  <th class="text-left p-3">Role</th>
                  <th class="text-left p-3">Actions</th>
                </tr>
              </thead>
              <tbody id="user-list"></tbody>
            </table>
          </div>

          <h3 class="text-lg font-semibold mt-8 mb-4">Bulk Savings Entry</h3>
          <p class="text-sm text-gray-600 mb-4">Record the same saving amount for all <strong>active</strong> members for a specific month.</p>
          <form onsubmit="recordBulkSavings(event)" class="form-grid">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Month *</label>
              <input type="month" id="bulkSavingMonth" required class="w-full px-4 py-2 border rounded-md">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Amount (रु) *</label>
              <input type="number" id="bulkSavingAmount" required class="w-full px-4 py-2 border rounded-md" placeholder="e.g., 500">
            </div>
            <div class="full">
                <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                <select id="bulkSavingStatus" class="w-full px-4 py-2 border rounded-md">
                    <option>Paid</option>
                    <option>Pending</option>
                </select>
            </div>
            <div class="full mt-2">
              <button type="submit" class="w-full md:w-auto bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700">
                <i class="fas fa-users-cog mr-2"></i> Record for All Active Members
              </button>
            </div>
          </form>
          <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-4">
            <button onclick="downloadBackup()" class="bg-indigo-600 text-white px-6 py-3 rounded hover:bg-indigo-700 font-medium flex items-center justify-center">
              <i class="fas fa-download mr-2"></i> Download Backup
            </button>
            <label class="bg-green-600 text-white px-6 py-3 rounded hover:bg-green-700 font-medium flex items-center justify-center cursor-pointer">
              <i class="fas fa-upload mr-2"></i> Restore Backup
              <input type="file" id="restoreFile" accept=".json" onchange="restoreBackup(event)" class="hidden">
            </label>
          </div>
        </div>
      </section>

      <div id="reportModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto p-8">
          <div class="flex justify-between items-start mb-6 border-b pb-4">
            <h3 id="reportTitle" class="text-2xl font-bold text-gray-800">Report</h3>
            <button onclick="closeModal('reportModal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
          </div>
          <div id="reportContent" class="space-y-6"></div>
          <div class="mt-6 flex justify-end">
            <button onclick="closeModal('reportModal')" class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Close</button>
          </div>
        </div>
      </div>

      <div id="addMemberModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6">
          <h3 class="text-xl font-bold mb-4">Add New Member</h3>
          <form onsubmit="addMember(event)" class="form-grid">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Member ID *</label>
              <input type="text" id="memberId" readonly class="w-full px-4 py-2 border rounded-md bg-gray-100" placeholder="e.g., M001">
            </div>
            <div class="full">
              <label class="block text-sm font-medium text-gray-700 mb-1">Full Name *</label>
              <input type="text" id="memberName" required class="w-full px-4 py-2 border rounded-md" placeholder="Enter full name">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
              <input type="text" id="memberPhone" class="w-full px-4 py-2 border rounded-md" placeholder="Enter phone number">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Join Date *</label>
              <input type="date" id="memberDate" required class="w-full px-4 py-2 border rounded-md">
            </div>
            <div class="full">
              <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
              <select id="memberStatus" class="w-full px-4 py-2 border rounded-md">
                <option>Active</option>
                <option>Inactive</option>
              </select>
            </div>
            <div class="full">
              <label class="block text-sm font-medium text-gray-700 mb-1">Residential Address</label>
              <input type="text" id="memberAddress" class="w-full px-4 py-2 border rounded-md" placeholder="Enter residential address">
            </div>
            <div class="full flex justify-end space-x-2">
              <button type="button" onclick="closeModal('addMemberModal')" class="px-4 py-2 border rounded-md">Cancel</button>
              <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Add Member</button>
            </div>
          </form>
        </div>
      </div>

      <div id="addLoanModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6">
          <h3 class="text-xl font-bold mb-4">Distribute New Loan</h3>
          <form onsubmit="addLoan(event)" class="form-grid">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Member *</label>
              <select id="loanMemberId" required class="w-full px-4 py-2 border rounded-md">
                </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Principal Amount (रु) *</label>
              <input type="number" id="loanPrincipal" required class="w-full px-4 py-2 border rounded-md" placeholder="Enter loan amount">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Monthly Interest Rate (%) *</label>
              <input type="number" id="loanRate" step="0.1" required class="w-full px-4 py-2 border rounded-md" placeholder="e.g., 2.5">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Loan Date *</label>
              <input type="date" id="loanDate" required class="w-full px-4 py-2 border rounded-md">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Duration (Months) *</label>
              <input type="number" id="loanDuration" required class="w-full px-4 py-2 border rounded-md" placeholder="e.g., 12">
            </div>
            <div class="full">
              <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
              <select id="loanStatus" class="w-full px-4 py-2 border rounded-md">
                <option>Active</option>
                <option>Inactive</option>
              </select>
            </div>
            <div class="full flex justify-end space-x-2">
              <button type="button" onclick="closeModal('addLoanModal')" class="px-4 py-2 border rounded-md">Cancel</button>
              <button type="submit" class="px-6 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700">Distribute Loan</button>
            </div>
          </form>
        </div>
      </div>

      <div id="addSavingModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6">
          <h3 class="text-xl font-bold mb-4">Record Monthly Saving</h3>
          <form onsubmit="addSaving(event)" class="form-grid">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Member *</label>
              <select id="savingMemberId" required class="w-full px-4 py-2 border rounded-md">
                <option value="">Select member</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Amount (रु) *</label>
              <input type="number" id="savingAmount" required class="w-full px-4 py-2 border rounded-md" placeholder="Enter amount">
            </div>
            <div class="full">
              <label class="block text-sm font-medium text-gray-700 mb-1">Month *</label>
              <input type="month" id="savingMonth" required class="w-full px-4 py-2 border rounded-md">
            </div>
            <div class="full">
              <label class="block text-sm font-medium text-gray-700 mb-1">Payment Status</label>
              <select id="savingStatus" class="w-full px-4 py-2 border rounded-md">
                <option>Paid</option>
                <option>Pending</option>
              </select>
            </div>
            <div class="full flex justify-end space-x-2">
              <button type="button" onclick="closeModal('addSavingModal')" class="px-4 py-2 border rounded-md">Cancel</button>
              <button type="submit" class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Record Saving</button>
            </div>
          </form>
        </div>
      </div>

      <div id="addPaymentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6">
          <h3 class="text-xl font-bold mb-4">Record Loan Payment</h3>
          <form onsubmit="addPayment(event)" class="form-grid">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Select Loan *</label>
              <select id="paymentLoanId" required class="w-full px-4 py-2 border rounded-md">
                <option value="">Select active loan</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Payment Month *</label>
              <input type="month" id="paymentMonth" required class="w-full px-4 py-2 border rounded-md">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Interest Amount (रु) *</label>
              <input type="number" id="paymentInterest" required class="w-full px-4 py-2 border rounded-md" placeholder="Monthly interest" oninput="calculatePaymentTotal('paymentInterest', 'paymentPrincipal', 'paymentTotal')">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Principal Amount (रु)</label>
              <input type="number" id="paymentPrincipal" class="w-full px-4 py-2 border rounded-md" placeholder="Leave as 0 for interest-only payment" oninput="calculatePaymentTotal('paymentInterest', 'paymentPrincipal', 'paymentTotal')">
            </div>
            <div class="full">
              <label class="block text-sm font-medium text-gray-700 mb-1">Total Payment (रु)</label>
              <input type="number" id="paymentTotal" readonly class="w-full px-4 py-2 border rounded-md bg-gray-100">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Payment Date</label>
              <input type="date" id="paymentDate" class="w-full px-4 py-2 border rounded-md">
            </div>
            <div class="full">
              <label class="block text-sm font-medium text-gray-700 mb-1">Payment Status</label>
              <select id="paymentStatus" class="w-full px-4 py-2 border rounded-md">
                <option>Pending</option>
                <option>Paid</option>
              </select>
            </div>
            <div class="full flex justify-end space-x-2">
              <button type="button" onclick="closeModal('addPaymentModal')" class="px-4 py-2 border rounded-md">Cancel</button>
              <button type="submit" class="px-6 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">Record Payment</button>
            </div>
          </form>
        </div>
      </div>

      <div id="editMemberModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6">
          <h3 class="text-xl font-bold mb-4">Edit Member</h3>
          <form onsubmit="saveEditedMember(event)" class="form-grid">
            <input type="hidden" id="editMemberId">
            <label class="block text-sm font-medium text-gray-700 mb-1 full">Full Name *</label>
            <input type="text" id="editMemberName" required class="full px-4 py-2 border rounded-md">
            
            <label class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
            <input type="text" id="editMemberPhone" class="w-full px-4 py-2 border rounded-md">
            
            <label class="block text-sm font-medium text-gray-700 mb-1">Join Date *</label>
            <input type="date" id="editMemberDate" required class="w-full px-4 py-2 border rounded-md">
            
            <label class="block text-sm font-medium text-gray-700 mb-1 full">Status</label>
            <div class="full">
              <select id="editMemberStatus" class="w-full px-4 py-2 border rounded-md">
                <option>Active</option>
                <option>Inactive</option>
              </select>
            </div>
            
            <label class="block text-sm font-medium text-gray-700 mb-1 full">Residential Address</label>
            <div class="full">
              <input type="text" id="editMemberAddress" class="w-full px-4 py-2 border rounded-md" placeholder="Enter residential address">
            </div>
            
            <div class="full flex justify-end space-x-2 mt-4">
              <button type="button" onclick="closeModal('editMemberModal')" class="px-4 py-2 border rounded-md">Cancel</button>
              <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Update Member</button>
            </div>
          </form>
        </div>
      </div>

      <div id="editLoanModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6">
          <h3 class="text-xl font-bold mb-4">Edit Loan</h3>
          <form onsubmit="saveEditedLoan(event)" class="form-grid">
            <input type="hidden" id="editLoanId">
            
            <label class="block text-sm font-medium text-gray-700 mb-1 full">Member *</label>
            <select id="editLoanMemberId" required class="full px-4 py-2 border rounded-md"></select>
            
            <label class="block text-sm font-medium text-gray-700 mb-1">Principal Amount (रु) *</label>
            <input type="number" id="editLoanPrincipal" required class="w-full px-4 py-2 border rounded-md">
            
            <label class="block text-sm font-medium text-gray-700 mb-1">Monthly Interest Rate (%) *</label>
            <input type="number" id="editLoanRate" step="0.1" required class="w-full px-4 py-2 border rounded-md">
            
            <label class="block text-sm font-medium text-gray-700 mb-1">Duration (Months) *</label>
            <input type="number" id="editLoanDuration" required class="w-full px-4 py-2 border rounded-md">
            
            <label class="block text-sm font-medium text-gray-700 mb-1">Loan Date *</label>
            <input type="date" id="editLoanDate" required class="w-full px-4 py-2 border rounded-md">
            
            <label class="block text-sm font-medium text-gray-700 mb-1 full">Status</label>
            <div class="full">
              <select id="editLoanStatus" class="w-full px-4 py-2 border rounded-md">
                <option>Active</option>
                <option>Inactive</option>
              </select>
            </div>
            
            <div class="full flex justify-end space-x-2 mt-4">
              <button type="button" onclick="closeModal('editLoanModal')" class="px-4 py-2 border rounded-md">Cancel</button>
              <button type="submit" class="px-6 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700">Update Loan</button>
            </div>
          </form>
        </div>
      </div>

      <div id="editSavingModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6">
          <h3 class="text-xl font-bold mb-4">Edit Saving</h3>
          <form onsubmit="saveEditedSaving(event)" class="form-grid">
            <input type="hidden" id="editSavingId">
            
            <label class="block text-sm font-medium text-gray-700 mb-1 full">Member *</label>
            <select id="editSavingMemberId" required class="full px-4 py-2 border rounded-md"></select>
            
            <label class="block text-sm font-medium text-gray-700 mb-1">Amount (रु) *</label>
            <input type="number" id="editSavingAmount" required class="w-full px-4 py-2 border rounded-md">
            
            <label class="block text-sm font-medium text-gray-700 mb-1">Month *</label>
            <input type="month" id="editSavingMonth" required class="w-full px-4 py-2 border rounded-md">
            
            <label class="block text-sm font-medium text-gray-700 mb-1 full">Payment Status</label>
            <div class="full">
              <select id="editSavingStatus" class="w-full px-4 py-2 border rounded-md">
                <option>Paid</option>
                <option>Pending</option>
              </select>
            </div>
            
            <div class="full flex justify-end space-x-2 mt-4">
              <button type="button" onclick="closeModal('editSavingModal')" class="px-4 py-2 border rounded-md">Cancel</button>
              <button type="submit" class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Update Saving</button>
            </div>
          </form>
        </div>
      </div>

      <div id="editPaymentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6">
          <h3 class="text-xl font-bold mb-4">Edit Payment</h3>
          <form onsubmit="saveEditedPayment(event)" class="form-grid">
            <input type="hidden" id="editPaymentId">
            
            <label class="block text-sm font-medium text-gray-700 mb-1 full">Loan *</label>
            <select id="editPaymentLoanId" required class="full px-4 py-2 border rounded-md"></select>
            
            <label class="block text-sm font-medium text-gray-700 mb-1">Payment Month *</label>
            <input type="month" id="editPaymentMonth" required class="w-full px-4 py-2 border rounded-md">
            
            <label class="block text-sm font-medium text-gray-700 mb-1">Interest Amount (रु) *</label>
            <input type="number" id="editPaymentInterest" required class="w-full px-4 py-2 border rounded-md" oninput="calculatePaymentTotal('editPaymentInterest', 'editPaymentPrincipal', 'editPaymentTotal')">
            
            <label class="block text-sm font-medium text-gray-700 mb-1">Principal Amount (रु)</label>
            <input type="number" id="editPaymentPrincipal" required class="w-full px-4 py-2 border rounded-md" oninput="calculatePaymentTotal('editPaymentInterest', 'editPaymentPrincipal', 'editPaymentTotal')">
            
            <label class="block text-sm font-medium text-gray-700 mb-1 full">Total Payment (रु)</label>
            <input type="number" id="editPaymentTotal" readonly class="bg-gray-100 full px-4 py-2 border rounded-md">
            
            <label class="block text-sm font-medium text-gray-700 mb-1">Payment Date</label>
            <input type="date" id="editPaymentDate" required class="w-full px-4 py-2 border rounded-md">
            
            <label class="block text-sm font-medium text-gray-700 mb-1 full">Payment Status</label>
            <div class="full">
              <select id="editPaymentStatus" class="w-full px-4 py-2 border rounded-md">
                <option>Pending</option>
                <option>Paid</option>
              </select>
            </div>
            
            <div class="full flex justify-end space-x-2 mt-4">
              <button type="button" onclick="closeModal('editPaymentModal')" class="px-4 py-2 border rounded-md">Cancel</button>
              <button type="submit" class="px-6 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">Update Payment</button>
            </div>
          </form>
        </div>
      </div>

    </main>
  </div>

  <script>
    // DATA
    let users = JSON.parse(localStorage.getItem("users") || JSON.stringify([
      { email: "useradmin@example.com", password: "useradmin", name: "Ranjit Singh", role: "admin" }
    ]));
    let members = JSON.parse(localStorage.getItem("members") || "[]");
    let savings = JSON.parse(localStorage.getItem("savings") || "[]");
    let loans = JSON.parse(localStorage.getItem("loans") || "[]");
    let payments = JSON.parse(localStorage.getItem("payments") || "[]");
    let currentUser = null;

    // ================== NEW PAYMENT HELPER FUNCTION ==================
    function calculatePaymentTotal(interestId, principalId, totalId) {
      const interest = parseFloat(document.getElementById(interestId).value) || 0;
      const principal = parseFloat(document.getElementById(principalId).value) || 0;
      document.getElementById(totalId).value = (interest + principal).toFixed(2);
    }

    // AUTH
    function handleSignIn(e) {
      e.preventDefault();
      const email = document.getElementById('signinEmail').value.trim().toLowerCase();
      const password = document.getElementById('signinPassword').value.trim();

      const user = users.find(u => 
        u.email.toLowerCase() === email && 
        u.password === password
      );

      if (!user) {
        alert("Invalid email or password.\nUse:  example@gmail.con / example123 ");
        return;
      }

      currentUser = user;
      localStorage.setItem("currentUser", JSON.stringify(user));
      document.getElementById("authModal").classList.add("hidden");
      document.getElementById("app").classList.remove("hidden");
      updateUserInfo();
      showSection('dashboard');
    }

    function logout() { 
      localStorage.removeItem("currentUser"); 
      location.reload(); 
    }

    function updateUserInfo() {
      const u = currentUser || JSON.parse(localStorage.getItem("currentUser") || 'null');
      if (!u) return;
      const name = u.name || u.email.split('@')[0];
      document.getElementById('userNameSmall').textContent = name;
      document.getElementById('userRoleSmall').textContent = u.role;
      document.getElementById('userAvatarSmall').textContent = name.charAt(0).toUpperCase();
    }

    // ROLE
    function getIsAdmin() {
      const user = currentUser || JSON.parse(localStorage.getItem("currentUser") || 'null');
      return user && user.role === 'admin';
    }

    function checkAuthorization() {
      const isAdmin = getIsAdmin();
      document.getElementById('nav-settings').style.display = isAdmin ? 'flex' : 'none';
      document.querySelectorAll('.admin-only').forEach(el => el.style.display = isAdmin ? '' : 'none');
    }

    // NAV
    function showSection(id) {
      if (id === 'settings' && !getIsAdmin()) id = 'dashboard';
      document.querySelectorAll('main section').forEach(s => s.classList.add('hidden'));
      document.getElementById(`section-${id}`).classList.remove('hidden');
      document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
      document.getElementById(`nav-${id}`).classList.add('active');
      const titles = { dashboard: ['Dashboard','Overview'], members: ['Members','Manage'], savings: ['Savings','Track'], loans: ['Loans','Manage'], payments: ['Payments','Track'], settings: ['Settings','Users'] };
      document.getElementById('headerTitle').textContent = titles[id][0];
      document.getElementById('headerSubtitle').textContent = titles[id][1];
      if (id === 'dashboard') loadDashboard();
      else if (id === 'members') renderMembers();
      else if (id === 'savings') renderSavings();
      else if (id === 'loans') renderLoans();
      else if (id === 'payments') renderPayments();
      else if (id === 'settings') renderUsers();
      checkAuthorization();
    }

    // DASHBOARD
    let lineChart, pieChart;
    function loadDashboard() { updateStats(); renderLineChart(); renderPieChart(); updateDefaulters(); }
    function updateStats() {
      document.getElementById('stat-members').textContent = members.length;
      const totalSavings = savings.reduce((a,s)=>a+(parseFloat(s.amount)||0),0);
      document.getElementById('stat-savings').textContent = `रु${totalSavings.toLocaleString()}`;
      const activeLoans = loans.filter(l=>l.status==='Active').reduce((a,l)=>a+(parseFloat(l.balance)||0),0);
      document.getElementById('stat-loans').textContent = `रु${activeLoans.toLocaleString()}`;
      const totalInterest = payments.reduce((a,p)=>a+(parseFloat(p.interest)||0),0);
      document.getElementById('stat-interest').textContent = `रु${totalInterest.toLocaleString()}`;
      const availableBalance = totalSavings - activeLoans;
      document.getElementById('stat-balance').textContent = `रु${availableBalance.toLocaleString()}`;
      document.getElementById('stat-growth').textContent = '+12%'; // Static
    }
    function renderLineChart() {
      const ctx = document.getElementById('lineChart').getContext('2d');
      if (lineChart) lineChart.destroy();
      lineChart = new Chart(ctx, { type: 'line', data: { labels: ['Jun','Jul','Aug','Sep','Oct','Nov'], datasets: [
        { label: 'Savings', data: [0,5000,10000,18000,25000,35000], borderColor: '#10b981', tension: 0.4 },
        { label: 'Loans', data: [0,3000,8000,15000,20000,30000], borderColor: '#3b82f6', tension: 0.4 }
      ]}, options: { responsive: true, plugins: { legend: { position: 'bottom' } }, maintainAspectRatio: false } });
    }

    // ================== PIE CHART (FIXED) ==================
    /**
     * Renders the pie chart.
     * FIX: Aggregates all loan principals by member, not just top 5 loans.
     */
    function renderPieChart() {
      const ctx = document.getElementById('pieChart').getContext('2d');
      if (pieChart) pieChart.destroy();
      
      // Group total loan principal by member
      const loanTotalsByMember = {};
      loans.forEach(loan => {
        const member = members.find(m => m.id === loan.memberId);
        const name = member?.name || 'Unknown';
        const principal = parseFloat(loan.principal) || 0;
        
        if (loanTotalsByMember[name]) {
          loanTotalsByMember[name] += principal;
        } else {
          loanTotalsByMember[name] = principal;
        }
      });

      const labels = Object.keys(loanTotalsByMember);
      const data = Object.values(loanTotalsByMember);
      
      // A predefined list of colors that will repeat
      const chartColors = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#6366f1', '#14b8a6', '#d946ef'];
      const backgroundColors = labels.map((_, i) => chartColors[i % chartColors.length]);
      
      // Update the chart title to be more accurate
      const chartTitle = document.querySelector('#pieChart').closest('.chart-container').querySelector('h3');
      if(chartTitle) chartTitle.textContent = 'Loan Distribution by Member';

      pieChart = new Chart(ctx, { 
        type: 'doughnut', 
        data: { 
          labels: labels, 
          datasets: [{ 
            data: data, 
            backgroundColor: backgroundColors 
          }] 
        }, 
        options: { 
          responsive: true, 
          plugins: { legend: { position: 'bottom' } }, 
          maintainAspectRatio: false 
        } 
      });
    }
    // ======================================================

    function updateDefaulters() {
      const month = new Date().toISOString().slice(0,7);
      const paidSavings = new Set(savings.filter(s=>s.month===month).map(s=>s.memberId));
      document.getElementById('defaulters-savings').textContent = members.filter(m=>!paidSavings.has(m.id)).length;
      const paidLoans = new Set(payments.filter(p=>p.month===month).map(p=>p.loanId));
      document.getElementById('defaulters-loans').textContent = loans.filter(l=>l.status==='Active' && !paidLoans.has(l.id)).length;
    }

    // RENDER TABLES
    function renderMembers() {
      const tbody = document.getElementById('member-list');
      document.getElementById('member-count').textContent = members.length;
      tbody.innerHTML = members.map(m=>`
        <tr class="border-b hover:bg-gray-50">
          <td class="p-3">${m.id}</td>
          <td class="p-3">${m.name}</td>
          <td class="p-3">${m.phone||'-'}</td>
          <td class="p-3">${m.joinDate}</td>
          <td class="p-3"><span class="${m.status==='Active'?'badge-active':'badge-inactive'}">${m.status}</span></td>
          <td class="p-3 space-x-2">
            <button onclick="showReportModal('member', '${m.id}')" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 text-xs font-semibold">Review Report</button>
          </td>
        </tr>
      `).join('') || '<tr><td colspan="6" class="p-3 text-center text-gray-500">No members</td></tr>';
    }

    function renderSavings() {
      const tbody = document.getElementById('saving-list');
      const grouped = Object.values(savings.reduce((acc, s) => {
        if (!acc[s.memberId]) acc[s.memberId] = { total: 0, memberId: s.memberId };
        acc[s.memberId].total += parseFloat(s.amount) || 0;
        return acc;
      }, {}));
      document.getElementById('saving-count').textContent = grouped.length;
      tbody.innerHTML = grouped.map(g => {
        const m = members.find(x => x.id === g.memberId);
        return `<tr class="border-b hover:bg-gray-50">
          <td class="p-3">${m?.name || 'Unknown'}</td>
          <td class="p-3 font-semibold">रु${g.total.toLocaleString()}</td>
          <td class="p-3">
            <button onclick="showReportModal('savings', '${g.memberId}')" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 text-xs font-semibold">Review Report</button>
          </td>
        </tr>`;
      }).join('') || '<tr><td colspan="3" class="p-3 text-center text-gray-500">No savings</td></tr>';
    }

    function renderLoans() {
      const tbody = document.getElementById('loan-list');
      document.getElementById('loan-count').textContent = loans.length;
      try {
        tbody.innerHTML = loans.map(l => {
          const m = members.find(x => x.id === l.memberId);
          return `<tr class="border-b hover:bg-gray-50">
            <td class="p-3">${m?.name || 'Unknown'}</td>
            <td class="p-3">रु${(l.principal || 0).toLocaleString()}</td>
            <td class="p-3 font-semibold">रु${(l.balance || 0).toLocaleString()}</td>
            <td class="p-3">${l.rate || 0}%</td>
            <td class="p-3">${l.date || '-'}</td>
            <td class="p-3"><span class="${(l.status==='Active'?'badge-active':'badge-inactive')}">${l.status || 'N/A'}</span></td>
            <td class="p-3 space-x-2">
              <button onclick="showReportModal('loan', '${l.id}')" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 text-xs font-semibold">Review Report</button>
              <button onclick="openEditLoan('${l.id}')" class="text-blue-600 hover:underline text-xs admin-only">Edit</button>
              <button onclick="deleteLoan('${l.id}')" class="text-red-600 hover:underline text-xs admin-only">Delete</button>
            </td>
          </tr>`;
        }).join('') || '<tr><td colspan="7" class="p-3 text-center text-gray-500">No loans</td></tr>';
      } catch (error) {
        console.error("Failed to render loans:", error);
        tbody.innerHTML = '<tr><td colspan="7" class="p-3 text-center text-red-500">Error rendering loan list. Check console.</td></tr>';
      }
      checkAuthorization();
    }

    function renderPayments() {
      const tbody = document.getElementById('payment-list');
      const grouped = Object.values(payments.reduce((acc, p) => {
        if (!acc[p.loanId]) acc[p.loanId] = { total: 0, loanId: p.loanId };
        acc[p.loanId].total += parseFloat(p.total) || 0;
        return acc;
      }, {}));
      document.getElementById('payment-count').textContent = grouped.length;
      tbody.innerHTML = grouped.map(g => {
        const l = loans.find(x => x.id === g.loanId);
        const m = members.find(x => x.id === l?.memberId);
        return `<tr class="border-b hover:bg-gray-50">
          <td class="p-3">${m?.name || 'Unknown'}</td>
          <td class="p-3">रु${(l?.principal || 0).toLocaleString()}</td>
          <td class="p-3 font-semibold">रु${g.total.toLocaleString()}</td>
          <td class="p-3">
            <button onclick="showReportModal('payments', '${g.loanId}')" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 text-xs font-semibold">Review Report</button>
          </td>
        </tr>`;
      }).join('') || '<tr><td colspan="4" class="p-3 text-center text-gray-500">No payments</td></tr>';
    }

    function renderUsers() {
      const tbody = document.getElementById('user-list');
      tbody.innerHTML = users.map(u => `
        <tr class="border-b">
          <td class="p-3">${u.name}</td>
          <td class="p-3">${u.email}</td>
          <td class="p-3"><span class="px-2 py-1 rounded-full text-xs ${u.role === 'admin' ? 'bg-purple-100 text-purple-800' : 'bg-gray-100 text-gray-800'}">${u.role}</span></td>
          <td class="p-3">
            ${u.email !== 'useradmin@example.com' ? `<button onclick="deleteUser('${u.email}')" class="text-red-600 hover:underline text-xs">Delete</button>` : ''}
          </td>
        </tr>
      `).join('');
    }

    // BACKUP & RESTORE
    function downloadBackup() {
      const data = { users: localStorage.getItem("users"), members: localStorage.getItem("members"), savings: localStorage.getItem("savings"), loans: localStorage.getItem("loans"), payments: localStorage.getItem("payments") };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `thaleshwor-backup-${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    function restoreBackup(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          if (confirm("This will overwrite all current data. Continue?")) {
            localStorage.setItem("users", data.users || "[]");
            localStorage.setItem("members", data.members || "[]");
            localStorage.setItem("savings", data.savings || "[]");
            localStorage.setItem("loans", data.loans || "[]");
            localStorage.setItem("payments", data.payments || "[]");
            location.reload();
          }
        } catch (err) {
          alert("Invalid backup file!");
        }
      };
      reader.readAsText(file);
    }

    // CRUD
    function generateId(prefix) { return prefix + Date.now().toString(36); }
    function generateMemberId() {
      const year = new Date().getFullYear().toString().slice(-2);
      const count = members.filter(m => m.id.startsWith(`M${year}`)).length + 1;
      return `M${year}${String(count).padStart(3, '0')}`;
    }

    // MEMBER CRUD
    function showAddMemberForm() {
      if (!getIsAdmin()) return alert("Admins only");
      document.getElementById('memberId').value = generateMemberId();
      document.getElementById('memberDate').valueAsDate = new Date();
      document.getElementById('addMemberModal').classList.remove('hidden');
    }
    function addMember(e) {
      e.preventDefault();
      const m = {
        id: document.getElementById('memberId').value,
        name: document.getElementById('memberName').value,
        phone: document.getElementById('memberPhone').value,
        joinDate: document.getElementById('memberDate').value,
        status: document.getElementById('memberStatus').value,
        address: document.getElementById('memberAddress').value
      };
      members.push(m);
      localStorage.setItem("members", JSON.stringify(members));
      closeModal('addMemberModal');
      renderMembers(); loadDashboard();
    }
    function openEditMember(id) {
      const m = members.find(x => x.id === id);
      document.getElementById('editMemberId').value = m.id;
      document.getElementById('editMemberName').value = m.name;
      document.getElementById('editMemberPhone').value = m.phone;
      document.getElementById('editMemberDate').value = m.joinDate;
      document.getElementById('editMemberStatus').value = m.status;
      document.getElementById('editMemberAddress').value = m.address;
      document.getElementById('editMemberModal').classList.remove('hidden');
      closeModal('reportModal');
    }
    function saveEditedMember(e) {
      e.preventDefault();
      const id = document.getElementById('editMemberId').value;
      const idx = members.findIndex(m => m.id === id);
      members[idx] = {
        id, name: document.getElementById('editMemberName').value,
        phone: document.getElementById('editMemberPhone').value,
        joinDate: document.getElementById('editMemberDate').value,
        status: document.getElementById('editMemberStatus').value,
        address: document.getElementById('editMemberAddress').value
      };
      localStorage.setItem("members", JSON.stringify(members));
      closeModal('editMemberModal');
      renderMembers(); loadDashboard();
    }
    function deleteMember(id) {
      if (!confirm("Delete member?")) return;
      members = members.filter(m => m.id !== id);
      savings = savings.filter(s => s.memberId !== id);
      const memberLoans = loans.filter(l => l.memberId === id).map(l => l.id);
      payments = payments.filter(p => !memberLoans.includes(p.loanId));
      loans = loans.filter(l => l.memberId !== id);

      localStorage.setItem("members", JSON.stringify(members));
      localStorage.setItem("savings", JSON.stringify(savings));
      localStorage.setItem("loans", JSON.stringify(loans));
      localStorage.setItem("payments", JSON.stringify(payments));
      
      closeModal('reportModal');
      renderMembers(); renderSavings(); renderLoans(); renderPayments(); loadDashboard();
    }

    // LOAN CRUD
    function showLoanForm() {
      if (!getIsAdmin()) return alert("Admins only");
      
      if (members.length === 0) {
        alert("You must add a member first before distributing a loan.");
        return;
      }

      document.getElementById('loanMemberId').innerHTML = members.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
      document.getElementById('loanDate').valueAsDate = new Date();
      document.getElementById('addLoanModal').classList.remove('hidden');
    }

    function addLoan(e) {
      e.preventDefault();
      const principal = parseFloat(document.getElementById('loanPrincipal').value);
      const l = {
        id: generateId('L'),
        memberId: document.getElementById('loanMemberId').value,
        principal, balance: principal,
        rate: parseFloat(document.getElementById('loanRate').value),
        duration: parseInt(document.getElementById('loanDuration').value),
        date: document.getElementById('loanDate').value,
        status: document.getElementById('loanStatus').value
      };
      loans.push(l);
      localStorage.setItem("loans", JSON.stringify(loans));
      closeModal('addLoanModal');
      renderLoans(); loadDashboard();
    }
    function openEditLoan(id) {
      if (!getIsAdmin()) return alert("Admins only");
      const l = loans.find(x => x.id === id);
      if (!l) return alert('Loan not found');
      document.getElementById('editLoanId').value = l.id;
      document.getElementById('editLoanMemberId').innerHTML = members.map(m => `<option value="${m.id}" ${m.id===l.memberId?'selected':''}>${m.name}</option>`).join('');
      document.getElementById('editLoanPrincipal').value = l.principal;
      document.getElementById('editLoanRate').value = l.rate;
      document.getElementById('editLoanDuration').value = l.duration;
      document.getElementById('editLoanDate').value = l.date;
      document.getElementById('editLoanStatus').value = l.status;
      document.getElementById('editLoanModal').classList.remove('hidden');
      closeModal('reportModal');
    }
    function saveEditedLoan(e) {
      e.preventDefault();
      if (!getIsAdmin()) return alert("Admins only");
      const id = document.getElementById('editLoanId').value;
      const idx = loans.findIndex(l => l.id === id);
      if (idx === -1) return alert('Loan not found');
      
      const oldPrincipal = loans[idx].principal;
      
      loans[idx].memberId = document.getElementById('editLoanMemberId').value;
      loans[idx].principal = parseFloat(document.getElementById('editLoanPrincipal').value);
      loans[idx].rate = parseFloat(document.getElementById('editLoanRate').value);
      loans[idx].duration = parseInt(document.getElementById('editLoanDuration').value);
      loans[idx].date = document.getElementById('editLoanDate').value;
      loans[idx].status = document.getElementById('editLoanStatus').value;

      if (loans[idx].principal !== oldPrincipal) {
        updateLoanBalance(id);
      }
      
      localStorage.setItem("loans", JSON.stringify(loans));
      closeModal('editLoanModal');
      renderLoans(); loadDashboard();
    }
    function deleteLoan(id) {
      if (!getIsAdmin()) return alert("Admins only");
      if (!confirm("Delete loan?")) return;
      loans = loans.filter(l => l.id !== id);
      payments = payments.filter(p => p.loanId !== id);
      localStorage.setItem("loans", JSON.stringify(loans));
      localStorage.setItem("payments", JSON.stringify(payments));
      closeModal('reportModal');
      renderLoans(); renderPayments(); loadDashboard();
    }

    // SAVING CRUD
    function showSavingForm() {
      if (!getIsAdmin()) return alert("Admins only");
      document.getElementById('savingMemberId').innerHTML = members.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
      document.getElementById('addSavingModal').classList.remove('hidden');
    }
    function addSaving(e) {
      e.preventDefault();
      if (!getIsAdmin()) return alert("Admins only");
      const s = {
        id: generateId('S'),
        memberId: document.getElementById('savingMemberId').value,
        amount: parseFloat(document.getElementById('savingAmount').value),
        month: document.getElementById('savingMonth').value,
        status: document.getElementById('savingStatus').value
      };
      savings.push(s);
      localStorage.setItem("savings", JSON.stringify(savings));
      closeModal('addSavingModal');
      renderSavings(); loadDashboard();
    }
    function openEditSaving(id, memberId) {
      if (!getIsAdmin()) return alert("Admins only");
      const s = savings.find(x => x.id === id);
      if (!s) return alert('Saving not found');
      document.getElementById('editSavingId').value = s.id;
      document.getElementById('editSavingMemberId').innerHTML = members.map(m => `<option value="${m.id}" ${m.id===s.memberId?'selected':''}>${m.name}</option>`).join('');
      document.getElementById('editSavingAmount').value = s.amount;
      document.getElementById('editSavingMonth').value = s.month;
      document.getElementById('editSavingStatus').value = s.status;
      document.getElementById('editSavingModal').classList.remove('hidden');
      closeModal('reportModal');
    }
    function saveEditedSaving(e) {
      e.preventDefault();
      if (!getIsAdmin()) return alert("Admins only");
      const id = document.getElementById('editSavingId').value;
      const idx = savings.findIndex(s => s.id === id);
      if (idx === -1) return alert('Saving not found');
      savings[idx].memberId = document.getElementById('editSavingMemberId').value;
      savings[idx].amount = parseFloat(document.getElementById('editSavingAmount').value);
      savings[idx].month = document.getElementById('editSavingMonth').value;
      savings[idx].status = document.getElementById('editSavingStatus').value;
      localStorage.setItem("savings", JSON.stringify(savings));
      closeModal('editSavingModal');
      renderSavings(); loadDashboard();
      showReportModal('savings', savings[idx].memberId);
    }
    function deleteSaving(id, memberId) {
      if (!getIsAdmin()) return alert("Admins only");
      if (!confirm("Delete saving?")) return;
      savings = savings.filter(s => s.id !== id);
      localStorage.setItem("savings", JSON.stringify(savings));
      renderSavings(); loadDashboard();
      showReportModal('savings', memberId);
    }

    // PAYMENT CRUD
    function showPaymentForm() {
      if (!getIsAdmin()) return alert("Admins only");
      
      const activeLoans = loans.filter(l => l.status === 'Active');
      
      if (activeLoans.length === 0) {
        alert("There are no active loans to make a payment on.");
        return;
      }
      
      try {
        document.getElementById('paymentLoanId').innerHTML = activeLoans.map(l => {
          const m = members.find(x => x.id === l.memberId);
          const balance = l.balance || 0;
          return `<option value="${l.id}">${m?.name || 'Unknown'} - रु${balance.toLocaleString()} left</option>`;
        }).join('');
      } catch (error) {
        console.error("Error populating payment form loans:", error);
        alert("An error occurred while loading active loans. Check console.");
        return;
      }
      
      document.getElementById('paymentDate').valueAsDate = new Date();
      document.getElementById('paymentTotal').value = '0.00';
      document.getElementById('addPaymentModal').classList.remove('hidden');
    }

    function addPayment(e) {
      e.preventDefault();
      if (!getIsAdmin()) return alert("Admins only");
      const loanId = document.getElementById('paymentLoanId').value;
      const month = document.getElementById('paymentMonth').value;
      const interest = parseFloat(document.getElementById('paymentInterest').value) || 0;
      const principal = parseFloat(document.getElementById('paymentPrincipal').value) || 0;
      const total = parseFloat(document.getElementById('paymentTotal').value) || 0;
      const date = document.getElementById('paymentDate').value;
      const status = document.getElementById('paymentStatus').value;
      const p = { id: generateId('P'), loanId, month, interest, principal, total, date, status };
      payments.push(p);
      localStorage.setItem("payments", JSON.stringify(payments));
      updateLoanBalance(loanId);
      closeModal('addPaymentModal');
      renderPayments(); loadDashboard();
    }
    function openEditPayment(id, loanId) {
      if (!getIsAdmin()) return alert("Admins only");
      const p = payments.find(x => x.id === id);
      if (!p) return alert('Payment not found');
      document.getElementById('editPaymentId').value = p.id;
      document.getElementById('editPaymentLoanId').innerHTML = loans.map(l => `<option value="${l.id}" ${l.id===p.loanId?'selected':''}>${members.find(m=>m.id===l.memberId)?.name}</option>`).join('');
      document.getElementById('editPaymentMonth').value = p.month;
      document.getElementById('editPaymentInterest').value = p.interest;
      document.getElementById('editPaymentPrincipal').value = p.principal;
      document.getElementById('editPaymentDate').value = p.date;
      document.getElementById('editPaymentStatus').value = p.status;
      document.getElementById('editPaymentTotal').value = p.total;

      document.getElementById('editPaymentModal').classList.remove('hidden');
      closeModal('reportModal');
    }
    function saveEditedPayment(e) {
      e.preventDefault();
      if (!getIsAdmin()) return alert("Admins only");
      const id = document.getElementById('editPaymentId').value;
      const idx = payments.findIndex(p => p.id === id);
      if (idx === -1) return alert('Payment not found');
      const oldLoanId = payments[idx].loanId;
      const newLoanId = document.getElementById('editPaymentLoanId').value;
      const interest = parseFloat(document.getElementById('editPaymentInterest').value) || 0;
      const principal = parseFloat(document.getElementById('editPaymentPrincipal').value) || 0;
      const total = parseFloat(document.getElementById('editPaymentTotal').value) || 0;

      payments[idx] = {
        id, loanId: newLoanId,
        month: document.getElementById('editPaymentMonth').value,
        interest, principal, total,
        date: document.getElementById('editPaymentDate').value,
        status: document.getElementById('editPaymentStatus').value
      };
      localStorage.setItem("payments", JSON.stringify(payments));
      
      if (oldLoanId !== newLoanId) {
        updateLoanBalance(oldLoanId);
      }
      updateLoanBalance(newLoanId);

      closeModal('editPaymentModal');
      renderPayments(); loadDashboard();
      showReportModal('payments', newLoanId);
    }
    function deletePayment(id, loanId) {
      if (!getIsAdmin()) return alert("Admins only");
      if (!confirm("Delete payment?")) return;
      payments = payments.filter(p => p.id !== id);
      localStorage.setItem("payments", JSON.stringify(payments));
      updateLoanBalance(loanId);
      renderPayments(); loadDashboard();
      showReportModal('payments', loanId);
    }
    
    function updateLoanBalance(loanId) {
      const loan = loans.find(l => l.id === loanId);
      if (!loan) return;
      const paid = payments.filter(p => p.loanId === loanId).reduce((a, p) => a + (parseFloat(p.principal) || 0), 0);
      loan.balance = loan.principal - paid;
      loan.status = loan.balance <= 0 ? 'Paid' : 'Active';
      localStorage.setItem("loans", JSON.stringify(loans));
    }

    // USER
    function createUser(e) {
      e.preventDefault();
      if (!getIsAdmin()) return alert("Only admins");
      const email = document.getElementById('newEmail').value.trim().toLowerCase();
      const password = document.getElementById('newPassword').value;
      const name = document.getElementById('newName').value.trim();
      const role = document.getElementById('newRole').value;
      if (users.some(u => u.email.toLowerCase() === email)) return alert("Email exists");
      users.push({ email, password, name, role });
      localStorage.setItem("users", JSON.stringify(users));
      renderUsers();
      e.target.reset();
    }
    function deleteUser(email) {
      if (!getIsAdmin()) return alert("Only admins");
      if (!confirm("Delete user?")) return;
      users = users.filter(u => u.email !== email);
      localStorage.setItem("users", JSON.stringify(users));
      renderUsers();
    }

    // ================== NEW BULK SAVING FUNCTION ==================
    function recordBulkSavings(e) {
      e.preventDefault();
      if (!getIsAdmin()) return alert("Only admins can perform this action.");
      
      const month = document.getElementById('bulkSavingMonth').value;
      const amount = parseFloat(document.getElementById('bulkSavingAmount').value);
      const status = document.getElementById('bulkSavingStatus').value; // Get the status
      
      if (!month || isNaN(amount) || amount <= 0) {
        return alert("Please enter a valid month and amount.");
      }

      const activeMembers = members.filter(m => m.status === 'Active');
      
      if (activeMembers.length === 0) {
        return alert("There are no active members to record savings for.");
      }

      if (!confirm(`This will add a saving of रु${amount} (Status: ${status}) for ${month} for all ${activeMembers.length} active members. Are you sure?`)) {
        return;
      }

      let newSavingsCount = 0;
      activeMembers.forEach(member => {
        const existingSaving = savings.find(s => s.memberId === member.id && s.month === month);
        
        if (!existingSaving) {
          const newSaving = {
            id: generateId('S'),
            memberId: member.id,
            amount: amount,
            month: month,
            status: status // Use selected status
          };
          savings.push(newSaving);
          newSavingsCount++;
        }
      });

      localStorage.setItem("savings", JSON.stringify(savings));
      
      alert(`Successfully recorded ${newSavingsCount} new savings. ${activeMembers.length - newSavingsCount} members already had a saving for this month.`);
      
      e.target.reset();
      
      // Refresh data
      if (document.getElementById('section-dashboard').classList.contains('hidden') === false) {
        loadDashboard(); // If on dashboard, reload stats
      } else if (document.getElementById('section-savings').classList.contains('hidden') === false) {
        renderSavings(); // If on savings page, re-render list
      }
    }
    // ==========================================================

    // UTILS
    function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
    function searchTable(tableId, query) {
      const rows = document.querySelectorAll(`#${tableId} tbody tr`);
      rows.forEach(r => r.style.display = r.textContent.toLowerCase().includes(query.toLowerCase()) ? '' : 'none');
    }

    // REPORT MODAL
    function showReportModal(type, id) {
        const modal = document.getElementById('reportModal');
        const content = document.getElementById('reportContent');
        const title = document.getElementById('reportTitle');
        let html = '';
        const isAdmin = getIsAdmin();

        if (type === 'member') {
            const member = members.find(m => m.id === id);
            if (!member) return alert("Member not found");

            const memberSavings = savings.filter(s => s.memberId === id);
            const memberLoans = loans.filter(l => l.memberId === id);
            const memberPayments = payments.filter(p => memberLoans.some(l => l.id === p.loanId));

            const totalSavings = memberSavings.reduce((a, s) => a + (parseFloat(s.amount) || 0), 0);
            const totalLoan = memberLoans.reduce((a, l) => a + (parseFloat(l.principal) || 0), 0);
            const totalPaid = memberPayments.reduce((a, p) => a + (parseFloat(p.total) || 0), 0);

            title.textContent = `${member.name} – Member Summary`;
            html += `
                <div class="space-y-2 mb-4">
                    <p><strong>Member ID:</strong> ${member.id}</p>
                    <p><strong>Status:</strong> <span class="${member.status==='Active'?'badge-active':'badge-inactive'}">${member.status}</span></p>
                    <p><strong>Joined:</strong> ${member.joinDate}</p>
                    <p><strong>Address:</strong> ${member.address || '-'}</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-green-50 border border-green-200 p-3 rounded-lg text-center">
                        <p class="text-sm text-gray-600">Total Savings</p>
                        <p class="text-2xl font-bold text-green-700">रु${totalSavings.toLocaleString()}</p>
                    </div>
                    <div class="bg-blue-50 border border-blue-200 p-3 rounded-lg text-center">
                        <p class="text-sm text-gray-600">Total Loans</p>
                        <p class="text-2xl font-bold text-blue-700">रु${totalLoan.toLocaleString()}</p>
                    </div>
                    <div class="bg-purple-50 border border-purple-200 p-3 rounded-lg text-center">
                        <p class="text-sm text-gray-600">Total Paid (Principal+Interest)</p>
                        <p class="text-2xl font-bold text-purple-700">रु${totalPaid.toLocaleString()}</p>
                    </div>
                </div>
                ${isAdmin ? `<div class="mb-6 flex justify-end">
                    <button onclick="openEditMember('${member.id}')" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm mr-2">Edit Member</button>
                    <button onclick="deleteMember('${member.id}')" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 text-sm">Delete Member</button>
                </div>` : ''}
                
                <h4 class="text-lg font-semibold border-b pb-2 mt-6 mb-4">Savings History</h4>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 border-b">
                            <tr>
                                <th class="text-left p-3">Month</th>
                                <th class="text-left p-3">Amount (रु)</th>
                                <th class="text-left p-3">Status</th>
                                <th class="text-left p-3">${isAdmin ? 'Actions' : ''}</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${memberSavings.map(s => `
                                <tr class="border-b hover:bg-gray-50">
                                    <td class="p-3">${s.month}</td>
                                    <td class="p-3">रु${(s.amount || 0).toLocaleString()}</td>
                                    <td class="p-3"><span class="${s.status==='Paid'?'badge-active':'badge-inactive'}">${s.status}</span></td>
                                    <td class="p-3 space-x-2">
                                        ${isAdmin ? `<button onclick="openEditSaving('${s.id}', '${member.id}')" class="text-blue-600 hover:underline text-xs">Edit</button>
                                        <button onclick="deleteSaving('${s.id}', '${member.id}')" class="text-red-600 hover:underline text-xs">Delete</button>` : ''}
                                    </td>
                                </tr>
                            `).join('') || '<tr><td colspan="4" class="p-3 text-center text-gray-500">No savings recorded.</td></tr>'}
                        </tbody>
                    </table>
                </div>

                <h4 class="text-lg font-semibold border-b pb-2 mt-8 mb-4">Loans Summary</h4>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 border-b">
                            <tr>
                                <th class="text-left p-3">ID</th>
                                <th class="text-left p-3">Principal (रु)</th>
                                <th class="text-left p-3">Balance (रु)</th>
                                <th class="text-left p-3">Rate (%)</th>
                                <th class="text-left p-3">Date</th>
                                <th class="text-left p-3">Status</th>
                                <th class="text-left p-3">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${memberLoans.map(l => `
                                <tr class="border-b hover:bg-gray-50">
                                    <td class="p-3">${l.id}</td>
                                    <td class="p-3">रु${(l.principal || 0).toLocaleString()}</td>
                                    <td class="p-3">रु${(l.balance || 0).toLocaleString()}</td>
                                    <td class="p-3">${l.rate || 0}%</td>
                                    <td class="p-3">${l.date || '-'}</td>
                                    <td class="p-3"><span class="${l.status==='Active'?'badge-active':'badge-inactive'}">${l.status || 'N/A'}</span></td>
                                    <td class="p-3 space-x-2">
                                        <button onclick="showReportModal('loan', '${l.id}')" class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 text-xs font-semibold">View Details</button>
                                    </td>
                                </tr>
                            `).join('') || '<tr><td colspan="7" class="p-3 text-center text-gray-500">No loans recorded.</td></tr>'}
                        </tbody>
                    </table>
                </div>
            `;
        } else if (type === 'savings') {
            const memberId = id;
            const member = members.find(m => m.id === memberId);
            const monthlySavings = savings.filter(s => s.memberId === memberId).sort((a,b) => b.month.localeCompare(a.month));

            title.textContent = `${member?.name || 'Unknown'} – All Savings Records`;
            html += `
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 border-b">
                            <tr>
                                <th class="text-left p-3">Saving ID</th>
                                <th class="text-left p-3">Month</th>
                                <th class="text-left p-3">Amount (रु)</th>
                                <th class="text-left p-3">Status</th>
                                <th class="text-left p-3">${isAdmin ? 'Actions' : ''}</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${monthlySavings.map(s => `
                                <tr class="border-b hover:bg-gray-50">
                                    <td class="p-3">${s.id}</td>
                                    <td class="p-3">${s.month}</td>
                                    <td class="p-3">रु${(s.amount || 0).toLocaleString()}</td>
                                    <td class="p-3"><span class="${s.status==='Paid'?'badge-active':'badge-inactive'}">${s.status}</span></td>
                                    <td class="p-3 space-x-2">
                                        ${isAdmin ? `<button onclick="openEditSaving('${s.id}', '${memberId}')" class="text-blue-600 hover:underline text-xs">Edit</button>
                                        <button onclick="deleteSaving('${s.id}', '${memberId}')" class="text-red-600 hover:underline text-xs">Delete</button>` : ''}
                                    </td>
                                </tr>
                            `).join('') || '<tr><td colspan="5" class="p-3 text-center text-gray-500">No savings records found.</td></tr>'}
                        </tbody>
                    </table>
                </div>
            `;
        } else if (type === 'loan') {
            const loan = loans.find(l => l.id === id);
            if (!loan) return alert("Loan not found");
            const member = members.find(m => m.id === loan.memberId);
            const loanPayments = payments.filter(p => p.loanId === id).sort((a,b) => b.month.localeCompare(a.month));

            const totalInterestPaid = loanPayments.reduce((a, p) => a + (parseFloat(p.interest) || 0), 0);
            const totalPrincipalPaid = loanPayments.reduce((a, p) => a + (parseFloat(p.principal) || 0), 0);
            const totalPaid = totalInterestPaid + totalPrincipalPaid;

            title.textContent = `${member?.name || 'Unknown'} – Loan Report (${loan.id})`;
            html += `
                <div class="space-y-2 mb-4">
                    <p><strong>Loan ID:</strong> ${loan.id}</p>
                    <p><strong>Member:</strong> ${member?.name || 'Unknown'}</p>
                    <p><strong>Principal Amount:</strong> रु${(loan.principal || 0).toLocaleString()}</p>
                    <p><strong>Monthly Rate:</strong> ${loan.rate || 0}%</p>
                    <p><strong>Duration:</strong> ${loan.duration || 0} months</p>
                    <p><strong>Start Date:</strong> ${loan.date || '-'}</p>
                    <p><strong>Status:</strong> <span class="${loan.status==='Active'?'badge-active':'badge-inactive'}">${loan.status || 'N/A'}</span></p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-red-50 border border-red-200 p-3 rounded-lg text-center">
                        <p class="text-sm text-gray-600">Outstanding Balance</p>
                        <p class="text-2xl font-bold text-red-700">रु${(loan.balance || 0).toLocaleString()}</p>
                    </div>
                    <div class="bg-purple-50 border border-purple-200 p-3 rounded-lg text-center">
                        <p class="text-sm text-gray-600">Principal Paid</p>
                        <p class="text-2xl font-bold text-purple-700">रु${totalPrincipalPaid.toLocaleString()}</p>
                    </div>
                    <div class="bg-yellow-50 border border-yellow-200 p-3 rounded-lg text-center">
                        <p class="text-sm text-gray-600">Interest Paid</p>
                        <p class="text-2xl font-bold text-yellow-700">रु${totalInterestPaid.toLocaleString()}</p>
                    </div>
                </div>
                ${isAdmin ? `<div class="mb-6 flex justify-end">
                    <button onclick="openEditLoan('${loan.id}')" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 text-sm mr-2">Edit Loan</button>
                    <button onclick="deleteLoan('${loan.id}')" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 text-sm">Delete Loan</button>
                </div>` : ''}

                <h4 class="text-lg font-semibold border-b pb-2 mt-6 mb-4">Payment History</h4>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 border-b">
                            <tr>
                                <th class="text-left p-3">Payment ID</th>
                                <th class="text-left p-3">Month</th>
                                <th class="text-left p-3">Interest (रु)</th>
                                <th class="text-left p-3">Principal (रु)</th>
                                <th class="text-left p-3">Total (रु)</th>
                                <th class="text-left p-3">Date</th>
                                <th class="text-left p-3">Status</th>
                                <th class="text-left p-3">${isAdmin ? 'Actions' : ''}</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${loanPayments.map(p => `
                                <tr class="border-b hover:bg-gray-50">
                                    <td class="p-3">${p.id}</td>
                                    <td class="p-3">${p.month}</td>
                                    <td class="p-3">रु${(p.interest || 0).toLocaleString()}</td>
                                    <td class="p-3">रु${(p.principal || 0).toLocaleString()}</td>
                                    <td class="p-3 font-semibold">रु${(p.total || 0).toLocaleString()}</td>
                                    <td class="p-3">${p.date || '-'}</td>
                                    <td class="p-3"><span class="${p.status==='Paid'?'badge-active':'badge-inactive'}">${p.status}</span></td>
                                    <td class="p-3 space-x-2">
                                        ${isAdmin ? `<button onclick="openEditPayment('${p.id}', '${loan.id}')" class="text-blue-600 hover:underline text-xs">Edit</button>
                                        <button onclick="deletePayment('${p.id}', '${loan.id}')" class="text-red-600 hover:underline text-xs">Delete</button>` : ''}
                                    </td>
                                </tr>
                            `).join('') || '<tr><td colspan="8" class="p-3 text-center text-gray-500">No payments recorded for this loan.</td></tr>'}
                        </tbody>
                    </table>
                </div>
            `;
        } else if (type === 'payments') {
            const loanId = id;
            const loan = loans.find(l => l.id === loanId);
            const member = members.find(m => m.id === loan?.memberId);
            const allPayments = payments.filter(p => p.loanId === loanId).sort((a,b) => b.month.localeCompare(a.month));
            
            title.textContent = `${member?.name || 'Unknown'} – All Payments for Loan ${loan?.id}`;
            html += `
                <p class="text-sm text-gray-600 mb-4">Displaying all payments for loan: <strong>${loan?.id || 'N/A'}</strong> (Principal: रु${(loan?.principal || 0).toLocaleString()})</p>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-50 border-b">
                            <tr>
                                <th class="text-left p-3">Payment ID</th>
                                <th class="text-left p-3">Month</th>
                                <th class="text-left p-3">Interest (रु)</th>
                                <th class="text-left p-3">Principal (रु)</th>
                                <th class="text-left p-3">Total (रु)</th>
                                <th class="text-left p-3">Status</th>
                                <th class="text-left p-3">${isAdmin ? 'Actions' : ''}</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${allPayments.map(p => `
                                <tr class="border-b hover:bg-gray-50">
                                    <td class="p-3">${p.id}</td>
                                    <td class="p-3">${p.month}</td>
                                    <td class="p-3">रु${(p.interest || 0).toLocaleString()}</td>
                                    <td class="p-3">रु${(p.principal || 0).toLocaleString()}</td>
                                    <td class="p-3 font-semibold">रु${(p.total || 0).toLocaleString()}</td>
                                    <td class="p-3"><span class="${p.status==='Paid'?'badge-active':'badge-inactive'}">${p.status}</span></td>
                                    <td class="p-3 space-x-2">
                                        ${isAdmin ? `<button onclick="openEditPayment('${p.id}', '${loanId}')" class="text-blue-600 hover:underline text-xs">Edit</button>
                                        <button onclick="deletePayment('${p.id}', '${loanId}')" class="text-red-600 hover:underline text-xs">Delete</button>` : ''}
                                    </td>
                                </tr>
                            `).join('') || '<tr><td colspan="7" class="p-3 text-center text-gray-500">No payments recorded for this loan.</td></tr>'}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        content.innerHTML = html;
        modal.classList.remove('hidden');
    }

    // ONLOAD
    window.onload = () => {
      if (localStorage.getItem("currentUser")) {
        currentUser = JSON.parse(localStorage.getItem("currentUser"));
        document.getElementById("authModal").classList.add("hidden");
        document.getElementById("app").classList.remove("hidden");
        updateUserInfo();
        showSection('dashboard');
      }
    };
  </script>

</body>

</html>


